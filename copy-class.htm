<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="renderer" content="webkit">
		<link rel="shortcut icon" href="img/favicon.ico">
		<title>新增课程</title>
		<link href="css/bootstrap.min.css" rel="stylesheet">
		<link href="css/bootstrap-reset.css" rel="stylesheet">
		<link href="assets/font-awesome/css/font-awesome.css" rel="stylesheet">
		<link href="assets/advanced-datatable/media/css/demo_table.css" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="assets/bootstrap-datetimepicker/css/datetimepicker.css">
		<link href="css/style.css" rel="stylesheet">
		<link href="css/style-responsive.css" rel="stylesheet">
		<link href="css/index.css" rel="stylesheet">
		<!--[if lt IE 9]>
			<script src="js/html5shiv.js"></script>
			<script src="js/respond.min.js"></script>
		<![endif]-->
	</head>

	<body id="teamBuyer" v-cloak>
		<section id="container">
			<header class="header white-bg">
				<div class="sidebar-toggle-box">
					<div data-placement="right" class="fa fa-bars tooltips">
					</div>
				</div>
				<a href="class-list.htm" class="logo">
					指南针教育
					<span>
           	 ADMIN
          </span>
				</a>
				<div class="top-nav ">
					<ul class="nav pull-right top-menu">
						<li class="dropdown">
							<a data-toggle="dropdown" class="dropdown-toggle" href="#">
								<span class="username">
                  {{admin}}
                </span>
								<b class="caret">
                </b>
							</a>
							<ul class="dropdown-menu extended logout">
								<li class="log-arrow-up">
								</li>
								<li>
									<a @click="out" href="javascript:;">
										<i class="fa fa-key">
                    </i> Log Out
									</a>
								</li>
								<li></li>
							</ul>
						</li>
					</ul>
				</div>
			</header>
			<aside>
				<div id="sidebar" class="nav-collapse">
					<ul class="sidebar-menu" id="nav-accordion">
						<li class="sub-menu">
							<a href="javascript:;" class="active">
								<i class="fa fa-book">
                </i>
								<span>
                 	 课程管理
                </span>
							</a>
							<ul class="sub">
								<li>
									<a href="class-list.htm">
										课程列表
									</a>
								</li>
								<li>
									<a href="add-class.htm">
										新增课程
									</a>
								</li>
							</ul>
						</li>
						<li class="sub-menu">
							<a href="javascript:;">
								<i class="fa fa-tasks">
                </i>
								<span>
             		 订单管理
                </span>
							</a>
							<ul class="sub">
								<li>
									<a href="order-list.htm">
										订单列表
									</a>
								</li>
							</ul>
						</li>
						<li class="sub-menu">
							<a href="javascript:;">
								<i class="fa fa-th">
                </i>
								<span>
          				分类管理
                </span>
							</a>
							<ul class="sub">
								<li>
									<a href="sort-list.htm">
										分类列表
									</a>
								</li>
							</ul>
						</li>
						<li class="sub-menu">
							<a href="javascript:;">
								<i class=" fa fa-user">
                </i>
								<span>
                  	客户管理
                </span>
							</a>
							<ul class="sub">
								<li>
									<a href="customer-list.htm">
										客户列表
									</a>
								</li>
								<li>
									<a href="customer-list2.htm">
										来源统计
									</a>
								</li>
							</ul>
						</li>
						<li class="sub-menu">
							<a href="javascript:;">
								<i class="fa fa-laptop">
                </i>
								<span>
              		顾问管理
                </span>
							</a>
							<ul class="sub">
								<li>
									<a href="adviser-list.htm">
										顾问列表
									</a>
								</li>
								<li>
									<a href="add-adviser.htm">
										新增顾问
									</a>
								</li>
							</ul>
						</li>
						<li class="sub-menu">
							<a href="javascript:;">
								<i class="fa fa-map-marker">
                </i>
								<span>
              		区域管理
                </span>
							</a>
							<ul class="sub">
								<li>
									<a href="area-list.htm">
										区域列表
									</a>
								</li>
							</ul>
						</li>
					</ul>
				</div>
			</aside>
			<section id="main-content" class="content">
				<section class="wrapper site-min-height">
					<div class="row">
						<div class="col-lg-12">
							<section class="panel">
								<header class="panel-heading">
									新增课程
								</header>
								<div class="panel-body">
									<div class="adv-table">
										<form class="form-horizontal">
											<div class="form-group">
												<label for="inputEmail3" class="col-sm-2 control-label">基本信息</label>
											</div>
											<div class="form-group">
												<label class="col-sm-2 control-label">类型</label>
												<div class="col-sm-8">
													<input v-model.trim="subject.type" name="type" type="radio" value="DEFAULT" />大团&nbsp&nbsp
													<input v-model.trim="subject.type" name="type" type="radio" value="INDIE" />小团&nbsp&nbsp
												</div>
											</div>
											<div class="form-group">
												<label class="col-sm-2 control-label">课程名称</label>
												<div class="col-sm-8">
													<input v-model.trim="subject.name" type="text" class="form-control" placeholder="请输入课程名称">
												</div>
											</div>
											<div class="form-group">
												<label class="col-sm-2 control-label">选择区域</label>
												<div class="col-sm-8">
													<label v-for="item in region">
										    		<input :value="item.id" type="checkbox" v-model="checkedCity">{{item.name}}
										    	</label>
												</div>
											</div>
											<div class="form-group">
												<label class="col-sm-2 control-label">课程图片</label>
												<div class="col-sm-8">
													<input v-model="imageUrl" id="file1" name="file" type="file">
													<div class="imgtxt text-warning">图片需为jpg或png格式并且大小在200k内</div>
													<img v-if="!imageUrl" class="adviser-img class-img" :src="subject.logo | addUrl"/>
												</div>
											</div>
											<div class="form-group">
												<label class="col-sm-2 control-label">拼团开始时间</label>
												<div class="col-sm-8">
													<input v-model="subject.startDate" size="16" type="text" readonly="" class="form_datetime form-control">
												</div>
											</div>
											<div class="form-group">
												<label class="col-sm-2 control-label">拼团结束时间</label>
												<div class="col-sm-8">
													<input v-model="subject.endDate" size="16" type="text" readonly="" class="form_datetime form-control">
												</div>
											</div>
											<!--<div class="form-group">
												<label class="col-sm-2 control-label">拼团状态</label>
												<div class="col-sm-8">
													<select v-model="subject.state" class="form-control" size="1" name="example_length">
														<option value="WAIT">未开始</option>
														<option value="START">拼团中</option>
													</select>
												</div>
											</div>-->
											<div class="form-group">
												<label class="col-sm-2 control-label">所属分类</label>
												<div class="col-sm-8">
													<select v-model="subject.categoryId" class="form-control" size="1" name="example_length">
														<option v-for="item in allSort" :value="item.id">{{item.name}}</option>
													</select>
												</div>
											</div>
											<div class="form-group">
												<label class="col-sm-2 control-label">预付款</label>
												<div class="col-sm-2">
													<input type="radio" checked="checked">支持预付款
												</div>
											</div>
											<div class="form-group">
												<label class="col-sm-2 control-label">预付款金额</label>
												<div class="col-sm-8">
													<input v-model.trim="subject.preAmount" type="text" class="form-control" placeholder="请输入预付款金额">
												</div>
											</div>
											<div class="form-group">
												<label class="col-sm-2 control-label">拼团单价</label>
												<div class="col-sm-8">
													<input v-model.trim="subject.price" type="text" class="form-control" placeholder="请输入拼团单价">
												</div>
											</div>
											<div class="form-group">
												<label class="col-sm-2 control-label">拼团规则</label>
												<div class="col-sm-8">
													<textarea id="codex" v-model="subject.codex" class="form-control" rows="3" placeholder="请输入拼团规则，不能超过255个字符"></textarea>
												</div>
											</div>
											<div class="form-group">
												<label class="col-sm-12 control-label">拼团价格区间设置 <span class="text-warning">注：开始数量、结束数量默认为包含当前填写的数字，并且价格只能填写数字</span> </label>
											</div>
											<div class="form-group">
												<div class="col-sm-10">
													<div class="responsive-table">
														<table class="display table table-bordered table-striped" id="example">
															<thead>
																<tr>
																	<th>开始数量</th>
																	<th>结束数量</th>
																	<th v-for="city in checkedCity">{{city | regionName}}价格</th>
																</tr>
															</thead>
															<tbody class="algin">
																<tr v-for="(ind1,list) in subject.priceIntervalList" class="gradeX">
																	<td><input :id="'start' + ind1" :value="list.startNum" class="form-control" type="text" /></td>
																	<td><input :id="'end' + ind1" :value="list.endNum" class="form-control" type="text" /></td>
																	<td v-for="(ind2,item) in checkedCity"><input :id="'price' + ind1 + ind2" :class="'price' + ind1" :value="list.regionIds[ind2][1]" class="form-control" type="text" /></td>
																</tr>
																<tr v-for="(ind3,item) in len" class="gradeX">
																	<td><input :id="'start' + (5-len+ind3)" class="form-control" type="text" /></td>
																	<td><input :id="'end' + (5-len+ind3)" class="form-control" type="text" /></td>
																	<td v-for="(ind4,item) in checkedCity"><input :id="'price' + (5-len+ind3) + ind4" :class="'price' + (5-len+ind3)" class="form-control" type="text" /></td>
																</tr>
															</tbody>
														</table>
													</div>
												</div>
											</div>
											<div class="form-group">
												<label class="col-sm-10 control-label">课程详情 <span class="text-warning">图片需为jpg或png格式并且大小在200k内，所有内容不能超过2048个字符</span></label>
											</div>
											<div class="form-group">
												<div class="col-sm-10">
													<textarea id="Text" name="Text" class="form-control ckeditor" rows="6">
                          </textarea>
												</div>
											</div>
											<div v-if="eror" class="form-group">
												<div class="col-sm-8 text-danger">{{eror}}</div>
											</div>
											<div class="form-group buttons">
												<div class="col-sm-8">
													<button @click="changeClass" type="button" class="btn btn-primary">新增课程</button>
												</div>
											</div>
										</form>
									</div>
								</div>
							</section>
						</div>
					</div>
				</section>
			</section>
			<footer class="site-footer">
				<div class="text-center">
					2017 &copy; 指南针教育 ADMIN
					<a href="#" class="go-top">
						<i class="fa fa-angle-up">
            </i>
					</a>
				</div>
			</footer>
		</section>
		<script src="js/jquery-1.8.3.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="js/jquery.dcjqaccordion.2.7.js"></script>
		<script src="js/jquery.scrollTo.min.js"></script>
		<script src="js/jquery.nicescroll.js"></script>
		<script src="assets/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
		<script src="assets/bootstrap-datetimepicker/js/bootstrap-datetimepicker.js"></script>
		<script src="assets/bootstrap-timepicker/js/bootstrap-timepicker.js"></script>
		<script src="js/common-scripts.js"></script>
		<script src="js/advanced-form-components.js"></script>
		<script src="assets/ckeditor/ckeditor.js"></script>
		<script src="js/vue.js"></script>
		<script src="js/ajaxfileupload.js"></script>
		<script src="js/common.js?verson=1"></script>
		<script>
			tb.isLogin("change-class.htm");
			var editor = CKEDITOR.replace('Text');
			$("td,th").addClass("text-center");
			var v = new Vue({
				el: '#teamBuyer',
				data: {
					admin: sessionStorage.getItem("admin"),
					region: [],
					checkedCity: [],
					allSort: [],
					weight: 1,
					regionIds: '',
					priceList: [],
					subject: {},
					len: 0,
					imageUrl: '',
					showTime: 2000,
					eror: ''
				},
				created: function() {
					this.getClass();
					this.getRegion();
					this.getSort();
				},
				filters: {
					state: function(str) {
						if(str == "WAIT") {
							return "未开始";
						} else if(str == "START") {
							return "拼团中";
						} else if(str == "END") {
							return "已结束";
						} else if(str == "STOP") {
							return "已终止";
						}
					},
					regionName: function(id) {
						for(var i = 0; i < this.region.length; i++) {
							if(id == this.region[i].id) {
								return this.region[i].name;
							}
						}
					},
					sort: function(id) {
						for(var i = 0; i < this.allSort.length; i++) {
							if(id == this.allSort[i].id) {
								return this.allSort[i].name;
							}
						}
					},
					addUrl:function(u){
						return url2+u;
					}
				},
				methods: {
					getRegion: function() {
						var that = this;
						$.get(url + "region/list_all", function(result) {
							console.log(result)
							for(var i = 0; i < result.data.length; i++) {
								if(result.data[i].regionList.length != 0) {
									for(var m = 0; m < result.data[i].regionList.length; m++) {
										that.region.push(result.data[i].regionList[m]);
									}
								}
							}
						});
					},
					getSort: function() {
						var that = this;
						$.get(url + "subject_category/list", {
							state: "",
							pageNum: 0,
							pageSize: 1000000
						}, function(result) {
							console.log(result)
							that.allSort = result.data;
						});
					},
					getClass: function() {
						var that = this;
						$.get(url + "subject/get", {
							id: sessionStorage.getItem("classId")
						}, function(result) {
							console.log(result);
							//							result.data.logo = url2 + result.data.logo;
							result.data.gmtCreate = that.getTime(result.data.gmtCreate);
							result.data.startDate = that.getTime(result.data.startDate);
							result.data.endDate = that.getTime(result.data.endDate);
							if(result.data.codex) {
								result.data.codex = result.data.codex.replace(/<br>/g, "\n");
							};
							CKEDITOR.instances.Text.setData(result.data.details);
							var temp = result.data.priceIntervalList;
							that.len = 5 - temp.length;
							var ids = result.data.regionIds.split(",");
							//							ids.pop();
							for(var k = 0; k < ids.length; k++) {
								ids[k] = Number(ids[k]);
								that.checkedCity.push(ids[k]);
							}
							var realObj = [];
							for(var i = 0; i < temp.length; i++) {
								var temp2 = [];
								temp[i].regionIds = temp[i].regionIds.split(',');
								//								temp[i].regionIds.pop();
								for(var m = 0; m < temp[i].regionIds.length; m++) {
									temp[i].regionIds[m] = temp[i].regionIds[m].split(':');
									var tempobj = {
										cityId: temp[i].regionIds[m][0],
										price: temp[i].regionIds[m][1]
									}
									temp2.push(tempobj);
								}
								realObj.push(temp2);
							}
							console.log(realObj);
							//							that.priceList = realObj;
							that.subject = result.data;
						});
					},
					changeClass: function() {
						var that = this;
						if(!tb.checkEmpty(that.subject.name, "课程名称不能为空")) return;
						if(!tb.checkLength(that.subject.name.length, 32, "课程名称长度不能超过32个字符")) return;
						var timestamp1 = Date.parse(new Date(that.subject.startDate));
						var timestamp2 = Date.parse(new Date(that.subject.endDate));
						if(timestamp1 > timestamp2) {
							that.eror = "拼团时间区间有误";
							setTimeout(function() {
								that.eror = "";
							}, that.showTime);
							return false;
						};
						if(!tb.checkEmpty(that.subject.preAmount, "预付款金额不能为空")) return;
						if(!tb.checkEmpty(that.subject.price, "课程原价不能为空")) return;
						if(!tb.checkEmpty(that.subject.codex, "拼团规则不能为空")) return;
						
						that.priceList=[];
						
						for(var m = 0; m < 5; m++) {
							if($("#start" + m).val() && $("#end" + m).val() && $(".price" + m).val()) {
								var regionIds = "";
								var regionIdsStr = "";
								for(var i = 0; i < that.checkedCity.length; i++) {
									regionIds += that.checkedCity[i] + ':' + $("#price" + m + i).val() + ',';
									regionIdsStr += that.checkedCity[i] + ',';
								}
								regionIds = regionIds.substring(0, regionIds.length - 1);
								regionIdsStr = regionIdsStr.substring(0, regionIdsStr.length - 1);
								console.log(regionIds)
								var priceInterval = {
									startNum: $("#start" + m).val(),
									endNum: $("#end" + m).val(),
									regionIds: regionIds
								}
								that.regionIds = regionIdsStr;
								that.priceList.push(priceInterval);
							}
						}
						var val = CKEDITOR.instances.Text.getData();
						var codex = ReplaceSeperator($("#codex").val());
						console.log(codex)
						console.log(that.regionIds)
						console.log(that.priceList)
						if(!tb.checkLength(codex.length, 255, "拼团规则长度不能超过255个字符")) return;
						if(!tb.checkLength(val.length, 2048, "课程详情长度不能超过2048个字符")) return;
						if(that.imageUrl) {
							$.ajaxFileUpload({
								type: "POST",
								url: url + 'subject/upload_logo', //用于文件上传的服务器端请求地址
								secureuri: false, //一般设置为false
								fileElementId: 'file1', //文件上传空间的id属性  <input type="file" id="file" name="file" />
								dataType: 'text', //返回值类型 一般设置为json
								success: function(data, status) //服务器成功响应处理函数
								{
									console.log(data)
									var start = data.indexOf(">");
									if(start != -1) {
										var end = data.indexOf("<", start + 1);
										if(end != -1) {
											data = data.substring(start + 1, end);
										}
									}
									data = JSON.parse(data);
									var imageUrl = data.data;
									console.log(data.data)
									var setData = {
										name: that.subject.name,
										type: that.subject.type,
										regionIds: that.regionIds,
										logo: imageUrl,
										startDate: timestamp1,
										endDate: timestamp2,
										categoryId: that.subject.categoryId,
										preAmount: that.subject.preAmount,
										price: that.subject.price,
										weight: that.weight,
										codex: codex,
										details: val,
										priceIntervalList: that.priceList
									};
									console.log(setData)
									$.ajax({
										type: 'POST',
										dataType: 'json',
										contentType: "application/json",
										data: JSON.stringify(setData),
										url: url + "subject/add",
										success: function(result) {
											console.log(result)
											if(result.code == 0) {
												window.location.href = "class-list.htm";
											} else {
												alert(result);
											}
										},
										error: function(xhr, type) {
											console.log(type);
										}
									})
								},
								error: function(data, status, e) //服务器响应失败处理函数
								{
									alert(e);
								}
							})
						} else {
							var setData = {
								name: that.subject.name,
								type: that.subject.type,
								regionIds: that.regionIds,
								logo: that.subject.logo,
								startDate: timestamp1,
								endDate: timestamp2,
								categoryId: that.subject.categoryId,
								preAmount: that.subject.preAmount,
								price: that.subject.price,
								weight: that.weight,
								codex: codex,
								details: val,
								priceIntervalList: that.priceList
							};
							console.log(setData)
							$.ajax({
								type: 'POST',
								dataType: 'json',
								contentType: "application/json",
								data: JSON.stringify(setData),
								url: url + "subject/add",
								success: function(result) {
									console.log(result)
									if(result.code == 0) {
										window.location.href = "class-list.htm";
									}
								},
								error: function(xhr, type) {
									console.log(type);
								}
							})
						}
					},
					getTime: function(d) {
						var date1 = new Date(d);
						var y = date1.getFullYear();
						var m = this.addZero(date1.getMonth() + 1);
						var d = this.addZero(date1.getDate());
						var h = this.addZero(date1.getHours());
						var m2 = this.addZero(date1.getMinutes());
						var s = this.addZero(date1.getSeconds());
						var date2 = y + "-" + m + "-" + d + " " + h + ":" + m2 + ":" + s;
						return date2;
					},
					addZero: function(obj) {
						if(obj < 10) {
							obj = '0' + obj;
						};
						return obj;
					},
					out: function() {
						tb.out();
					}
				}
			});

			function ReplaceSeperator(mobiles) {
				var i;
				var result = "";
				var c;
				for(i = 0; i < mobiles.length; i++) {
					c = mobiles.substr(i, 1);
					if(c == "\n")
						result = result + "<br>";
					else if(c != "\r")
						result = result + c;
				}
				return result;
			}
		</script>
	</body>

</html>