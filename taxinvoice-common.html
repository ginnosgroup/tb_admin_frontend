<meta charset="utf-8"/>
<meta http-equiv="Pragma" content="no-cache" />   
<meta http-equiv="Cache-Control" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<div id="taxinvoice_app_sub">
<div class="modal fade" id="addservicefee_id" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static">
		<div class="modal-dialog" role="document" style="width:850px;">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="addservicefee_id_title">Add Service Fee Tax Invoice</h4>
				</div>
				<div id="alert_success" class="alert alert-success fade in" style="display:none;position:absolute;z-index:9999;">
		      <button data-dismiss="alert" class="close close-sm" type="button">
		      <i class="fa fa-times"></i>
		      </button>
		      <strong>Success!</strong> You  just achieved success.
		  	</div>
		  	<div id="alert_error" class="alert alert-block alert-danger fade in" style="display:none;position:absolute;z-index:9999;">
	        <button data-dismiss="alert" class="close close-sm" type="button">
	        <i class="fa fa-times"></i>
	        </button>
	        <strong id="error_info"></strong>
	      </div>
	      <form class="cmxform form-inline" style="" name="addservicefee_form" id="addservicefee_form">
				<div class="modal-body">						
						<input type="hidden" name="ids" id="ids" value="" />
						<div class="form-group" id="show_b0" style="width:100%;height:40px;display:none;">
							<label class="control-label" style="width:120px;">发票ID：</label>							
							<label name="b0" id="b0"></label>
						</div>
						<div class="form-group" style="width:100%;height:40px;">
							<label class="control-label" style="width:120px;">请选择地区：<span style="color:red;">*</span></label>							
							<select class="form-control" style="width:150px;" name="b1" id="b1"></select>
						</div>
						<div class="form-group" style="width:100%;height:40px;">
							<label class="control-label" style="width:120px;">Company Title：<span style="color:red;">*</span></label>							
							<select class="form-control" style="width:300px;" name="b2" id="b2"></select>
							<label class="control-label" style="margin-left:20px;">ABN：<span id="b2a"></span></label>
						</div>
						<div class="form-group" style="width:100%;height:40px;">
							<label class="control-label" style="width:120px;">Address：</label>							
							<label class="control-label" style="width:300px;" name="b3" id="b3"></label>
							<label class="control-label" style="margin-left:20px;">Tel：<span id="b3a"></span></label>
						</div>
						<div class="form-group" style="width:100%;height:40px;">							
							<label class="control-label" style="width:120px;">E-mail：</label>
							<label class="control-label" style="" id="b3b"></label>
						</div>
						<div class="form-group" style="width:100%;height:40px;line-height:40px;text-align:center;border-top: 1px solid #e5e5e5;border-bottom: 1px solid #e5e5e5;">							
							<label class="control-label" style="font-weight:bold;">Tax Invoice</label>
						</div>
						<div class="form-group" style="width:100%;margin-top:10px;line-height:40px;text-align:right;">
							<label class="control-label" style="font-weight:bold;">Bill To：<span style="color:red;">*</span></label>
							<input type="text" autocomplete="off" name="b4c" id="b4c" class="form-control" style="width:300px;font-weight:normal;">
							<label class="control-label" style="font-weight:bold;">Invoice No.：</label>
							<label class="control-label" style="width:60px;" id="b4a"></label>
							<label class="control-label" style="font-weight:bold;">Invoice Date：</label>
							<label class="control-label" style=""><input type="text" autocomplete="off" name="b4b" id="b4b" class="form-control default-date-picker" style="width:120px;font-weight:normal;"></label>
						</div>
						<div class="form-group" style="width:100%;line-height:40px;">
							<label class="control-label"><strong>Description</strong></label>
							<label class="control-label" style="margin-left:20px;"><a href="javascript:import_commission('VISA');">导入数据</a></label>
							<table class="table table-bordered">
		             <thead style="background-color:#efefef;">
		                <tr>
		                   <th>No.</th>
		                   <th>DESCRIPTION</th>
		                   <th>UNIT PRICE</th>
		                   <th>QUANTITY</th>
		                   <th>AMOUNT</th>
		                   <th style="text-align:center;"><a  @click="table_insert"><i class="fa fa-plus-square"></i></a></th>
		                </tr>		                
		             </thead>
		             		<tr v-for="item in subject" id="d{{item.id}}" class="gradeX">
		             				<td v-html="item.id"></td>
												<td v-html="item.description"></td>
												<td v-html="item.unitprice"></td>
												<td v-html="item.quantity"></td>
												<td v-html="item.amount"></td>
												<td style="text-align:center;"><a @click="table_remove($index)"><i class="fa fa-minus-square"></i></a></td>
		             		</tr>
		             <tbody>             			 
		             </tbody>
		          </table>
						</div>
						<div class="form-group" style="width:100%;line-height:20px;text-align:right;">							
							<div>
									<label class="control-label" style="font-weight:bold;">Subtotal：</label>
									<label class="control-label" style="" id="b6a">0.00</label>
							</div>							
						</div>
						<div class="form-group" style="width:100%;line-height:20px;text-align:right;">							
							<div>
									<label class="control-label" style="font-weight:bold;">10%GST：</label>
									<label class="control-label" style="" id="b6b">0.00</label>
							</div>								
						</div>
						<div class="form-group" style="width:100%;line-height:20px;text-align:right;">							
							<div>
									<label class="control-label" style="font-weight:bold;">Invoice total with GST：</label>
									<label class="control-label" style="" id="b6c">0.00</label>
							</div>								
						</div>
						<div class="form-group" style="width:100%;line-height:40px;">
							<label class="control-label">Note</label>
							<textarea id="b7" class="form-control" style="width:98%;font-weight:normal;"></textarea>
						</div>
						<div class="form-group" style="width:100%;line-height:40px;">
							<label class="control-label"><strong>Please make payment to the account below,and quote the invoice number:<strong></label>
							<table class="table table-bordered">
		             <thead style="background-color:#efefef;">
		                <tr>
		                   <th style="width:150px;">Bank Name</th>
		                   <th>Commonwealth Bank</th>
		                </tr>
		             </thead>
		             <tbody style="font-weight:normal;">
		                <tr>
		                   <td>Account Name</td>
		                   <td><label id="b5a"></label></td>
		                </tr>	
		                <tr>
		                   <td>BSB</td>
		                   <td><label id="b5b"></label></td>
		                </tr>
		                <tr>
		                   <td>Account No.</td>
		                   <td><label id="b5c"></label></td>
		                </tr>
		             </tbody>
		          </table>
						</div>						
				</div>
				<div class="modal-footer" style="text-align: center;">
					<button v-if="invoiceNo===''" id="btnSubmit" type="submit" class="btn btn-primary"><span id="btn_id">保存并下载</span></button>
					<button v-if="invoiceNo!==''" id="btnSubmit" type="submit" class="btn btn-primary"><span id="btn_id">修改并下载</span></button>
					<button id="btnReview" type="button" onclick="preview_form()" class="btn btn-primary" style="display:none;">预览</button>
					<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
				</div>
				</form>
			</div>
		</div>
</div>
<div class="modal fade" id="addovst_id" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static">
		<div class="modal-dialog" role="document" style="width:90%;">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="addovst_id_title">Add 留学 Tax Invoice</h4>
				</div>
				<div id="alert_success" class="alert alert-success fade in" style="display:none;position:absolute;z-index:9999;">
		      <button data-dismiss="alert" class="close close-sm" type="button">
		      <i class="fa fa-times"></i>
		      </button>
		      <strong>Success!</strong> You  just achieved success.
		  	</div>
		  	<div id="alert_error" class="alert alert-block alert-danger fade in" style="display:none;position:absolute;z-index:9999;">
	        <button data-dismiss="alert" class="close close-sm" type="button">
	        <i class="fa fa-times"></i>
	        </button>
	        <strong id="error_info"></strong>
	      </div>
	      <form class="cmxform form-inline" style="" name="addovst_form" id="addovst_form">
				<div class="modal-body">						
						<input type="hidden" name="current_tab" id="current_tab" value="{{current_tab}}" />
						<input type="hidden" name="ids_normal" id="ids_normal" value="" />
						<input type="hidden" name="ids_markteting" id="ids_markteting" value="" />
						<div class="form-group" style="width:100%;height:40px;">
							<label class="control-label" style="width:120px;">请选择地区：<span style="color:red;">*</span></label>							
							<select class="form-control" style="width:150px;" name="b1" id="b1"></select>
						</div>
						<div class="form-group" style="width:100%;height:40px;">
							<label class="control-label" style="width:120px;">Company Title：<span style="color:red;">*</span></label>							
							<select class="form-control" style="width:300px;" name="b2" id="b2"></select>
							<label class="control-label" style="margin-left:20px;">ABN：<span id="b2a"></span></label>
						</div>
						<div class="form-group" style="width:100%;height:40px;">
							<label class="control-label" style="width:120px;">Address：</label>							
							<label class="control-label" style="width:300px;" name="b3" id="b3"></label>
							<label class="control-label" style="margin-left:20px;">Tel：<span id="b3a"></span></label>
						</div>
						<div class="form-group" style="width:100%;height:40px;">							
							<label class="control-label" style="width:120px;">E-mail：</label>
							<label class="control-label" style="" id="b3b"></label>
						</div>
						<div class="form-group" style="width:100%;height:40px;line-height:40px;text-align:center;border-top: 1px solid #e5e5e5;border-bottom: 1px solid #e5e5e5;">							
							<label class="control-label" style="font-weight:bold;">Tax Invoice</label>
						</div>
						<div class="form-group" style="width:100%;line-height:40px;text-align:right;">							
							<label class="control-label" style="font-weight:bold;">Invoice No.：</label>
							<label class="control-label" style="" id="b4a"></label>
							<label class="control-label" style="font-weight:bold;">Invoice Date：</label>
							<label class="control-label" style=""><input type="text" autocomplete="off" name="b4b" id="b4b" class="form-control default-date-picker" style="width:120px;font-weight:normal;"></label>
						</div>
						<div class="form-group" style="width:100%;">
							<label class="control-label" style="width:120px;">Bill to：</label>
						</div>
						<div class="form-group" style="width:100%;height:40px;">
							<label class="control-label" style="width:120px;">Company：</label>							
							<select class="form-control" style="width:300px;" name="b8a" id="b8a"></select>
							<label id="label_b8d">请输入公司名称：<input type="text" autocomplete="off" name="b8d" id="b8d" class="form-control" style="width:300px;font-weight:normal;"></label>
						</div>
						<div class="form-group" style="width:100%;height:40px;">
							<label class="control-label" style="width:120px;">ABN：</label>
							<input type="text" autocomplete="off" name="b8b" id="b8b" class="form-control" style="width:300px;font-weight:normal;">
						</div>
						<div class="form-group" style="width:100%;">
							<label class="control-label" style="width:120px;">Address：</label>
							<input type="text" autocomplete="off" name="b8c" id="b8c" class="form-control" style="width:70%;font-weight:normal;">
						</div>
						<div class="form-group" style="width:100%;line-height:40px;">
							<label class="control-label"><strong>Description</strong></label>
							<label class="control-label" style="margin-left:20px;"><a href="javascript:import_commission('OVST');">导入数据</a></label>
							<ul class="nav nav-tabs">
                <li class="active" id="li_normal">
                   <a data-toggle="tab" href="#normal" onclick="setTab('normal');">Normal</a>
                </li>
                <li class="" id="li_markteting">
                   <a data-toggle="tab" href="#markteting" onclick="setTab('markteting');">Markteting fee</a>
                </li>                
              </ul>
              <div class="tab-content">
              		<div id="normal" class="tab-pane active">
									<table class="table table-bordered" id="tab_normal" style="margin-top:10px;">
				             <thead style="background-color:#efefef;">
				                <tr>
				                   <th>No.</th>
				                   <th>Student Name</th>
				                   <th>DOB</th>
				                   <th>Student ID</th>
				                   <th>Course</th>
				                   <th>Start Date</th>
				                   <th>Installment</th>
				                   <th>Tuition Fee</th>
				                   <th>Commission Rate</th>
				                   <th>Commission</th>
				                   <th>Bonus Amount</th>
				                   <th style="text-align:center;"><a  @click="table_insert_normal"><i class="fa fa-plus-square"></i></a></th>
				                </tr>		                
				             </thead>
				             <tbody style="font-weight:normal;">
				             		<tr v-for="item in subject_normal" id="d{{item.id}}" class="gradeX">
				             				<td v-html="item.id"></td>
														<td v-html="item.studentname"></td>
														<td v-html="item.dob"></td>
														<td v-html="item.studentId"></td>
														<td v-html="item.course"></td>
														<td v-html="item.startDate"></td>
														<td v-html="item.instalMent"></td>
														<td v-html="item.tuitionFee"></td>
														<td v-html="item.commissionrate"></td>
														<td v-html="item.commission"></td>
														<td v-html="item.bonus"></td>
														<td style="text-align:center;"><a @click="table_remove_normal($index)"><i class="fa fa-minus-square"></i></a></td>
				             		</tr>           			 
				             </tbody>
				          </table>
				          <div  style="width:100%;line-height:20px;text-align:right;">							
										<label class="control-label" style="font-weight:bold;">10%GST：</label>
										<label class="control-label" style="" id="b6a">0.00</label>								
									</div>
									<div style="width:100%;line-height:20px;text-align:right;">							
										<label class="control-label" style="font-weight:bold;">Invoice total with GST：</label>
										<label class="control-label" style="" id="b6b">0.00</label>							
									</div>
				        	</div>
				        	<div id="markteting" class="tab-pane">
				          <table class="table table-bordered" id="tab_markteting" style="margin-top:10px;">
				             <thead style="background-color:#efefef;">
				                <tr>
				                   <th>No.</th>
				                   <th>Student Name</th>
				                   <th>DOB</th>
				                   <th>Student ID</th>
				                   <th>Course</th>
				                   <th>Start Date</th>
				                   <th>Installment</th>
				                   <th>Tuition Fee</th>				                   
				                   <th>Marketing Bonus</th>
				                   <th style="text-align:center;"><a  @click="table_insert_markteting"><i class="fa fa-plus-square"></i></a></th>
				                </tr>		                
				             </thead>
				             <tbody style="font-weight:normal;">
				             		<tr v-for="item in subject_markteting" id="dm{{item.id}}" class="gradeX">
				             				<td v-html="item.id"></td>
														<td v-html="item.studentname"></td>
														<td v-html="item.dob"></td>
														<td v-html="item.studentId"></td>
														<td v-html="item.course"></td>
														<td v-html="item.startDate"></td>
														<td v-html="item.instalMent"></td>
														<td v-html="item.tuitionFee"></td>
														<td v-html="item.marketing"></td>
														<td style="text-align:center;"><a @click="table_remove_markteting($index)"><i class="fa fa-minus-square"></i></a></td>
				             		</tr>				                         			 
				             </tbody>
				          </table>
				          <div  style="width:100%;line-height:20px;text-align:right;">							
										<label class="control-label" style="font-weight:bold;">10%GST：</label>
										<label class="control-label" style="" id="b6c">0.00</label>								
									</div>
									<div style="width:100%;line-height:20px;text-align:right;">							
										<label class="control-label" style="font-weight:bold;">Invoice total with GST：</label>
										<label class="control-label" style="" id="b6d">0.00</label>							
									</div>
				        	</div>
		        	</div>
						</div>												
						<div class="form-group" style="width:100%;line-height:40px;">
							<label class="control-label">Note</label>
							<textarea id="b7" class="form-control" style="width:98%;font-weight:normal;"></textarea>
						</div>
						<div class="form-group" style="width:100%;line-height:40px;">
							<label class="control-label"><strong>Please make payment to the account below,and quote the invoice number:<strong></label>
							<table class="table table-bordered">
		             <thead style="background-color:#efefef;">
		                <tr>
		                   <th style="width:150px;">Bank Name</th>
		                   <th>Commonwealth Bank</th>
		                </tr>
		             </thead>
		             <tbody style="font-weight:normal;">
		                <tr>
		                   <td>Account Name</td>
		                   <td><label id="b5a"></label></td>
		                </tr>	
		                <tr>
		                   <td>BSB</td>
		                   <td><label id="b5b"></label></td>
		                </tr>
		                <tr>
		                   <td>Account No.</td>
		                   <td><label id="b5c"></label></td>
		                </tr>
		             </tbody>
		          </table>
						</div>						
				</div>
				<div class="modal-footer" style="text-align: center;">										
					<button v-if="invoiceNo===''" id="btnSubmit" type="submit" class="btn btn-primary"><span id="btn_id">保存并下载</span></button>
					<button v-if="invoiceNo!==''" id="btnSubmit" type="submit" class="btn btn-primary"><span id="btn_id">修改并下载</span></button>
					<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
				</div>
				</form>
			</div>
		</div>
</div>
</div>
<style>
.cmxform .form-group select.error, .cmxform .form-group textarea.error {
    border-color: #B94A48 !important;
}
</style>
<script>
var v_sub_taxinvoice = new Vue({
		el: '#taxinvoice_app_sub',
		data: {
			admin: sessionStorage.getItem("admin"),
			ap_list: sessionStorage.getItem("ap_list"),
			m_list: localStorage.getItem("str_html"),
			adviser_id: sessionStorage.getItem("adviser_id"),
			official_id: sessionStorage.getItem("official_id"),
			mara_id: sessionStorage.getItem("mara_id"),
			addservicefee_id: 0,
			addovst_id: 0,
			subtotal: 0,
			gsttotal: 0,
			gsttotal_normal: 0,
			gsttotal_markteting: 0,
			total_with_gst: 0,
			total_with_gst_normal: 0,
			total_with_gst_markteting: 0,
			subject: [],
			subject_normal: [],
			subject_markteting: [],
			invoices: [],
			bill_company: [],
			billCpId: 0,
			row_nums: 0,
			row_nums_normal: 0,
			row_nums_markteting: 0,
			bind_total: 0,
			bind_total_normal: 0,
			bind_total_markteting: 0,
			current_tab: 'normal',
			invoiceNo: '',			
		},
		created: function() {				
		},
		methods: {
				table_insert() {
						var index = 0;
						var tindex = 0;
						if (this.subject.length) index = this.subject.length;
						tindex = index+1;										
						this.subject.splice(index,0, {
						id: index+1,									
						description: '<input type="text" class="form-control small" style="" id="ta" value="">',
						unitprice: '<input type="text" class="form-control small" style="width:80px;" id="tb" onkeyup="total_amount(\'price\',this.value,$(this).parent().parent().attr(\'id\'));" value="">',
						quantity: '<select class="form-control small" style="width:80px;" id="tc" onchange="total_amount(\'quantity\',this.value,$(this).parent().parent().attr(\'id\'))"><option value=\'1\'>1</option><option value=\'2\'>2</option><option value=\'3\'>3</option><option value=\'4\'>4</option><option value=\'5\'>5</option></select>',
						amount: '<input type="text" autocomplete="off" class="form-control small" style="width:80px;" id="td" readonly="readonly" value="">',
						});
						this.row_nums++;
				},
				table_remove: function (index) {
					 var ids = $("#addservicefee_id #ids").val();
					 if (ids != '')
					 {
					 		 var arr = ids.split(',');
					 		 arr.splice(index,1);
					 		 ids = arr.join(',');
					 		 $("#addservicefee_id #ids").val(ids);
					 }
           this.subject.splice(index, 1);
           this.row_nums--;
           //对No重写
           for(var i=0;i<this.subject.length;i++)
           {           		
           		this.subject[i].id = i+1;           		
           }
           this.bind_total = 1;
        },
        table_insert_normal() {
						var index = 0;
						var tindex = 0;
						if (this.subject_normal.length) index = this.subject_normal.length;
						tindex = index+1;										
						this.subject_normal.splice(index,0, {
						id: index+1,									
						studentname: '<input type="text" class="form-control small" style="" id="ta" value="">',
						dob: '<input type="text" class="form-control small default-date-picker" style="width:110px;" id="tb" value="">',
						studentId: '<input type="text" class="form-control small" style="width:80px;" id="tc" value="">',
						course: '<textarea class="form-control" style="width:150px;" id="td"></textarea>',
						startDate: '<input type="text" class="form-control small default-date-picker" style="width:110px;" id="te" value="">',
						instalMent: '<select class="form-control small" style="width:80px;" id="tf"><option value=\'1\'>1</option><option value=\'2\'>2</option><option value=\'3\'>3</option><option value=\'4\'>4</option><option value=\'5\'>5</option><option value=\'6\'>6</option><option value=\'7\'>7</option><option value=\'8\'>8</option><option value=\'9\'>9</option><option value=\'10\'>10</option><option value=\'11\'>11</option><option value=\'12\'>12</option></select>',
						tuitionFee: '<input type="text" autocomplete="off" class="form-control small" style="width:100px;" id="tg" value="">',
						commissionrate: '<input type="text" autocomplete="off" class="form-control small" style="width:100px;" id="th" value="">',
						commission: '<input type="text" autocomplete="off" class="form-control small" style="width:100px;" id="ti" onkeyup="total_withgst_normal();" value="">',
						bonus: '<input type="text" autocomplete="off" class="form-control small" style="width:100px;" id="tj" onkeyup="total_withgst_normal();" value="">',
						});
						this.row_nums_normal++;
				},
				table_remove_normal: function (index) {
					 var ids = $("#addovst_id #ids_normal").val();
					 if (ids != '')
					 {
					 		 var arr = ids.split(',');
					 		 arr.splice(index,1);
					 		 ids = arr.join(',');
					 		 $("#addovst_id #ids_normal").val(ids);
					 }
           this.subject_normal.splice(index, 1);
           this.row_nums_normal--;
           //对No.重写
           for(var i=0;i<this.subject_normal.length;i++)
           {           		
           		this.subject_normal[i].id = i+1;           		
           }
           this.bind_total_normal = 1;
        },
        table_insert_markteting() {
						var index = 0;
						var tindex = 0;
						if (this.subject_markteting.length) index = this.subject_markteting.length;
						tindex = index+1;										
						this.subject_markteting.splice(index,0, {
						id: index+1,									
						studentname: '<input type="text" class="form-control small" style="" id="ta" value="">',
						dob: '<input type="text" class="form-control small default-date-picker" style="width:110px;" id="tb" value="">',
						studentId: '<input type="text" class="form-control small" style="width:80px;" id="tc" value="">',
						course: '<textarea class="form-control" style="width:150px;" id="td"></textarea>',
						startDate: '<input type="text" class="form-control small default-date-picker" style="width:110px;" id="te" value="">',
						instalMent: '<select class="form-control small" style="width:80px;" id="tf"><option value=\'1\'>1</option><option value=\'2\'>2</option><option value=\'3\'>3</option><option value=\'4\'>4</option><option value=\'5\'>5</option><option value=\'6\'>6</option><option value=\'7\'>7</option><option value=\'8\'>8</option><option value=\'9\'>9</option><option value=\'10\'>10</option><option value=\'11\'>11</option><option value=\'12\'>12</option></select>',
						tuitionFee: '<input type="text" autocomplete="off" class="form-control small" style="width:100px;" id="tg" value="">',						
						marketing: '<input type="text" autocomplete="off" class="form-control small" style="width:100px;" id="th" onkeyup="total_withgst_markteting()" value="">',
						});
						this.row_nums_markteting++;
				},
				table_remove_markteting: function (index) {
					 var ids = $("#addovst_id #ids_markteting").val();
					 if (ids != '')
					 {
					 		 var arr = ids.split(',');
					 		 arr.splice(index,1);
					 		 ids = arr.join(',');
					 		 $("#addovst_id #ids_markteting").val(ids);
					 }
           this.subject_markteting.splice(index, 1);
           this.row_nums_markteting--;
           //对No.重写
           for(var i=0;i<this.subject_markteting.length;i++)
           {           		
           		this.subject_markteting[i].id = i+1;           		
           }
           this.bind_total_markteting = 1;
        },
		}
});

function addservicefee()
{
		$('#addservicefee_id #addservicefee_id_title').html('Add Service Fee Tax Invoice');
		$('#addservicefee_id').modal('show');
		//重置数据
		v_sub_taxinvoice.invoices = [];
		$('#addservicefee_id #b1').removeAttr("disabled");
		$('#addservicefee_id #b2').removeAttr("disabled");
		$('#addservicefee_id #show_b0').hide();
		$('#addservicefee_id #addservicefee_form')[0].reset();
		$("#addservicefee_id #b2a").html('');
  	$("#addservicefee_id #b3").html('');
  	$("#addservicefee_id #b3a").html('');
  	$("#addservicefee_id #b3b").html('');
  	$("#addservicefee_id #b4a").html('');
  	$("#addservicefee_id #b4b").val('');
  	$("#addservicefee_id #b4c").val('');
  	$("#addservicefee_id #b5a").html('');
  	$("#addservicefee_id #b5b").html('');
  	$("#addservicefee_id #b5c").html('');
  	$("#addservicefee_id #b6a").html('0.00');
  	$("#addservicefee_id #b6b").html('0.00');
  	$("#addservicefee_id #b6c").html('0.00');
  	v_sub_taxinvoice.invoiceNo = '';
  	v_sub_taxinvoice.subject = [];
  	v_sub_taxinvoice.row_nums = 0;
		v_sub_taxinvoice.addservicefee_id = 1;
}

function addservicefee_visa(ids,userName,serviceName,amount)
{
		$('#addservicefee_id #addservicefee_id_title').html('Add Service Fee Tax Invoice');
		$('#addservicefee_id').modal('show');
		//重置数据
		v_sub_taxinvoice.invoices = [];
		$('#addservicefee_id #b1').removeAttr("disabled");
		$('#addservicefee_id #b2').removeAttr("disabled");
		$('#addservicefee_id #show_b0').hide();
		$('#addservicefee_id #addservicefee_form')[0].reset();
		$("#addservicefee_id #b2a").html('');
  	$("#addservicefee_id #b3").html('');
  	$("#addservicefee_id #b3a").html('');
  	$("#addservicefee_id #b3b").html('');
  	$("#addservicefee_id #b4a").html('');
  	$("#addservicefee_id #b4b").val('');
  	$("#addservicefee_id #b5a").html('');
  	$("#addservicefee_id #b5b").html('');
  	$("#addservicefee_id #b5c").html('');
  	$("#addservicefee_id #b6a").html('0.00');
  	$("#addservicefee_id #b6b").html('0.00');
  	$("#addservicefee_id #b6c").html('0.00');
  	$("#addservicefee_id #ids").val(ids);
  	v_sub_taxinvoice.subject = [];
  	var index = 0;				
		if (v_sub_taxinvoice.subject.length) index = v_sub_taxinvoice.subject.length;
		var tindex = index+1;
		v_sub_taxinvoice.subject.splice(index,0, {
		id: index+1,									
		description: '<input type="text" class="form-control small" style="" id="ta" value="'+userName+' '+serviceName+'">',
		unitprice: '<input type="text" class="form-control small" style="width:80px;" id="tb" onkeyup="total_amount(\'price\',this.value,$(this).parent().parent().attr(\'id\'))" value="'+amount+'">',
		quantity: '<select class="form-control small" style="width:80px;" id="tc" onchange="total_amount(\'quantity\',this.value,$(this).parent().parent().attr(\'id\'))"><option value=\'1\'>1</option><option value=\'2\'>2</option><option value=\'3\'>3</option><option value=\'4\'>4</option><option value=\'5\'>5</option></select>',
		amount: '<input type="text" autocomplete="off" class="form-control small" style="width:80px;" id="td" readonly="readonly" value="'+amount+'">',
		});
		v_sub_taxinvoice.row_nums = 1;
		v_sub_taxinvoice.addservicefee_id = 1;
		v_sub_taxinvoice.bind_total = 1;
}

function addovst()
{
		$('#addovst_id').modal('show');
		$('#addovst_id #addovst_id_title').html('Add 留学 Tax Invoice');
		//重置数据
		v_sub_taxinvoice.invoices = [];
		$('#addovst_id #b1').removeAttr("disabled");
		$('#addovst_id #b2').removeAttr("disabled");
		$('#addovst_id #addovst_form')[0].reset();
		$("#addovst_id #b2a").html('');
  	$("#addovst_id #b3").html('');
  	$("#addovst_id #b3a").html('');
  	$("#addovst_id #b3b").html('');
  	$("#addovst_id #b4a").html('');
  	$("#addovst_id #b4b").val('');
  	$("#addovst_id #b4c").val('');
  	$("#addovst_id #b5a").html('');
  	$("#addovst_id #b5b").html('');
  	$("#addovst_id #b5c").html('');  	
		$("#addovst_id #b6a").html('0.00');
  	$("#addovst_id #b6b").html('0.00');
  	$("#addovst_id #b6c").html('0.00');
  	$("#addovst_id #b6d").html('0.00');
  	$("#addovst_id #b7").html('');
  	$("#addovst_id #label_b8d").hide();
  	v_sub_taxinvoice.invoiceNo = '';
  	v_sub_taxinvoice.subject_normal = [];
  	v_sub_taxinvoice.subject_markteting = [];
  	v_sub_taxinvoice.row_nums_normal = 0;
  	v_sub_taxinvoice.billCpId = 0;  	
		v_sub_taxinvoice.addovst_id = 1;
}

$("#addservicefee_id #b1").live('change', function (e) {
		loadcompany('#addservicefee_id');
});

$("#addservicefee_id #b2").live('change', function (e) {
		loadcompany('#addservicefee_id');
});

$("#addovst_id #b1").live('change', function (e) {
		loadcompany('#addovst_id');
});

$("#addovst_id #b2").live('change', function (e) {
		loadcompany('#addovst_id');
});

$("#addovst_id #b8a").live('change', function (e) {
		var b8a = $("#addovst_id #b8a").val();		
		if (parseInt(b8a))
		{
				$("#addovst_id #label_b8d").hide();
				$("#addovst_id #b8b").val(v_sub_taxinvoice.bill_company[b8a].abn);
				$("#addovst_id #b8c").val(v_sub_taxinvoice.bill_company[b8a].address);
		}else
		{
				 if (b8a == '0')
				 {
				 		$("#addovst_id #label_b8d").show();
				 }else
				 {
				 		$("#addovst_id #label_b8d").hide();
				 }
				$("#addovst_id #b8b").val('');
				$("#addovst_id #b8c").val('');
		}
});

function loadcompany(f)
{		
		var b1 = $(f+" #b1").val();
		var b2 = $(f+" #b2").val();
		var str_url = url+'invoice/addServicefee?company='+b2+'&branch='+b1;
		if (f == '#addovst_id') str_url = url+'invoice/addSchool?company='+b2+'&branch='+b1;
		if (b1 != '' && b2 != '')
		{
				$.ajax({
			    url: str_url,
			    type: 'GET',
			    dataType: 'json'
			  }).done(function(response) {
			  	var result_data = response.data;
			  	v_sub_taxinvoice.invoices = result_data;
			  	$(f+" #b2a").html(result_data.abn);
			  	$(f+" #b3").html(result_data.address);
			  	$(f+" #b3a").html(result_data.tel);
			  	$(f+" #b3b").html(result_data.email);
			  	$(f+" #b4a").html(result_data.invoiceNo);
					$(f+" #b4b").val(result_data.invoiceDate);
			  	$(f+" #b5a").html(result_data.name);
			  	$(f+" #b5b").html(result_data.bsb);
			  	$(f+" #b5c").html(result_data.account);
			  });
		}else
		{
				$(f+" #b2a").html('');
		  	$(f+" #b3").html('');
		  	$(f+" #b3a").html('');
		  	$(f+" #b3b").html('');
		  	$(f+" #b4a").html('');
		  	$(f+" #b4b").val('');
		  	$(f+" #b5a").html('');
		  	$(f+" #b5b").html('');
		  	$(f+" #b5c").html('');
		}
}

function import_commission(type)
{
		var str_url = "mycommission-accounting.html?commission_state=YJY";
		if (type == 'OVST') str_url = "mycommission-ovst-accounting.html?commission_state=YJY";
		localStorage.setItem("is_select", "yes");
		window.open(str_url,"newwin","height=500, width=800, top=150, left=300, toolbar=no, menubar=no,scrollbars=yes,resizable=no, location=no, status=no");
}

function setTab(name)
{
		v_sub_taxinvoice.current_tab = name;
}

function createTable(nums,str)
{
		var arr = new Array();
		var arr_sub = new Array();
		//清空表格
		//v_sub_taxinvoice.subject = [];
		//v_sub_taxinvoice.row_nums = 0;
		arr = str.split('#');
		for(var i=0;i < nums;i++)
		{				
				arr_sub = arr[i].split(',');
				var index = 0;				
				if (v_sub_taxinvoice.subject.length) index = v_sub_taxinvoice.subject.length;
				var tindex = index+1;
				v_sub_taxinvoice.subject.splice(index,0, {
				id: index+1,									
				description: '<input type="text" class="form-control small" style="" id="ta" value="'+arr_sub[1]+' '+arr_sub[2]+'">',
				unitprice: '<input type="text" class="form-control small" style="width:80px;" id="tb" onkeyup="total_amount(\'price\',this.value,$(this).parent().parent().attr(\'id\'))" value="'+arr_sub[3]+'">',
				quantity: '<select class="form-control small" style="width:80px;" id="tc" onchange="total_amount(\'quantity\',this.value,$(this).parent().parent().attr(\'id\'))"><option value=\'1\'>1</option><option value=\'2\'>2</option><option value=\'3\'>3</option><option value=\'4\'>4</option><option value=\'5\'>5</option></select>',
				amount: '<input type="text" autocomplete="off" class="form-control small" style="width:80px;" id="td" readonly="readonly" value="'+arr_sub[3]+'">',
				});
				v_sub_taxinvoice.row_nums++;					
		}
		v_sub_taxinvoice.bind_total = 1;
}

function createOvstTable(nums,str)
{
		var arr = new Array();
		var arr_sub = new Array();
		var f = '#addovst_id ';
		//清空表格，暂时取消
		arr = str.split('#');
		if (v_sub_taxinvoice.current_tab == 'normal')
		{				
				for(var i=0;i < nums;i++)
				{
						arr_sub = arr[i].split(',');
						//console.log(arr_sub);
						var commissionrate = '';
						if (parseFloat(arr_sub[8])) commissionrate = (Math.round((parseFloat(arr_sub[8])/parseFloat(arr_sub[7]))*100)/100)*100+'%';
						var index = 0;				
						if (v_sub_taxinvoice.subject_normal.length) index = v_sub_taxinvoice.subject_normal.length;						
						var tindex = index+1;						
						v_sub_taxinvoice.subject_normal.splice(index,0, {
						id: index+1,									
						studentname: '<input type="text" class="form-control small" style="" id="ta" value="'+arr_sub[1]+'">',
						dob: '<input type="text" class="form-control small default-date-picker" style="width:110px;" id="tb" value="'+arr_sub[2]+'">',
						studentId: '<input type="text" class="form-control small" style="width:80px;" id="tc" value="'+arr_sub[3]+'">',
						course: '<textarea class="form-control" style="width:150px;" id="td">'+arr_sub[4]+'</textarea>',
						startDate: '<input type="text" class="form-control small default-date-picker" style="width:110px;" id="te" value="'+arr_sub[5]+'">',
						instalMent: '<input type="text" class="form-control small" style="width:80px;" id="tf" value="'+arr_sub[6]+'">',
						tuitionFee: '<input type="text" autocomplete="off" class="form-control small" style="width:100px;" id="tg" value="'+arr_sub[9]+'">',
						commissionrate: '<input type="text" autocomplete="off" class="form-control small" style="width:100px;" id="th" value="'+commissionrate+'">',
						commission: '<input type="text" autocomplete="off" class="form-control small" style="width:100px;" id="ti" onkeyup="total_withgst_normal();" value="'+arr_sub[8]+'">',
						bonus: '<input type="text" autocomplete="off" class="form-control small" style="width:100px;" id="tj" onkeyup="total_withgst_normal();" value="">',
						});						
						v_sub_taxinvoice.row_nums_normal++;
				}
				v_sub_taxinvoice.bind_total_normal = 1;
		}else if (v_sub_taxinvoice.current_tab == 'markteting')
		{
				for(var i=0;i < nums;i++)
				{
						arr_sub = arr[i].split(',');						
						var index = 0;				
						if (v_sub_taxinvoice.subject_markteting.length) index = v_sub_taxinvoice.subject_markteting.length;						
						var tindex = index+1;						
						v_sub_taxinvoice.subject_markteting.splice(index,0, {
						id: index+1,									
						studentname: '<input type="text" class="form-control small" style="" id="ta" value="'+arr_sub[1]+'">',
						dob: '<input type="text" class="form-control small default-date-picker" style="width:110px;" id="tb" value="'+arr_sub[2]+'">',
						studentId: '<input type="text" class="form-control small" style="width:80px;" id="tc" value="'+arr_sub[3]+'">',
						course: '<input type="text" class="form-control small" style="width:150px;" id="td" value="'+arr_sub[4]+'">',
						startDate: '<input type="text" class="form-control small default-date-picker" style="width:110px;" id="te" value="'+arr_sub[5]+'">',
						instalMent: '<input type="text" class="form-control small" style="width:80px;" id="tf" value="'+arr_sub[6]+'">',
						tuitionFee: '<input type="text" autocomplete="off" class="form-control small" style="width:100px;" id="tg" value="'+arr_sub[7]+'">',						
						marketing: '<input type="text" autocomplete="off" class="form-control small" style="width:100px;" id="th" onkeyup="total_withgst_markteting();" value="">',
						});						
						v_sub_taxinvoice.row_nums_markteting++;
				}
				v_sub_taxinvoice.bind_total_markteting = 1;				
		}		
}

function total_amount(type,value,parentid)
{		
		var amount = 0;
		var price = $("#addservicefee_id #"+parentid+" #tb").val();
		var quantity = $("#addservicefee_id #"+parentid+" #tc").val();
		if (type == 'price')
		{
				amount = parseFloat(value)*parseInt(quantity);
				$("#addservicefee_id #"+parentid+" #td").val(amount);
		}else if (type == 'quantity')
		{
				amount = parseInt(value)*parseFloat(price);
				$("#addservicefee_id #"+parentid+" #td").val(amount);
		}
		total_withgst();
}

function total_withgst()
{
		var total_with_gst = 0;
		var tindex = 0;
		for(var i=0;i < v_sub_taxinvoice.subject.length;i++)
		{
				tindex = i+1;
				if ($("#addservicefee_id #d"+tindex+" #td").val() != '')
				{
						total_with_gst += parseFloat($("#addservicefee_id #d"+tindex+" #td").val());
				}else
				{
						total_with_gst += 0;
				}
		}
		v_sub_taxinvoice.total_with_gst = Math.round(total_with_gst*100)/100;
		v_sub_taxinvoice.gsttotal = Math.round((v_sub_taxinvoice.total_with_gst/11)*100)/100;
		v_sub_taxinvoice.subtotal = Math.round((total_with_gst - v_sub_taxinvoice.gsttotal)*100)/100;
		$("#addservicefee_id #b6a").html(v_sub_taxinvoice.subtotal);
		$("#addservicefee_id #b6b").html(v_sub_taxinvoice.gsttotal);
		$("#addservicefee_id #b6c").html(v_sub_taxinvoice.total_with_gst);
}

function total_withgst_normal()
{
		var total_with_gst_normal = 0;
		var ti = 0;
		var tj = 0;
		var tindex = 0;
		for(var i=0;i < v_sub_taxinvoice.subject_normal.length;i++)
		{
				tindex = i+1;
				ti = 0;
				tj = 0;
				if ($("#addovst_id #d"+tindex+" #ti").val() != '') ti = $("#addovst_id #d"+tindex+" #ti").val();		
				if ($("#addovst_id #d"+tindex+" #tj").val() != '') tj = $("#addovst_id #d"+tindex+" #tj").val();
				total_with_gst_normal += parseFloat(ti)+parseFloat(tj);
		}
		v_sub_taxinvoice.total_with_gst_normal = Math.round(total_with_gst_normal*100)/100;
		v_sub_taxinvoice.gsttotal_normal = Math.round((v_sub_taxinvoice.total_with_gst_normal/11)*100)/100;
		$("#addovst_id #b6a").html(v_sub_taxinvoice.gsttotal_normal);
		$("#addovst_id #b6b").html(v_sub_taxinvoice.total_with_gst_normal);
}

function total_withgst_markteting()
{
		var total_with_gst_markteting = 0;
		var th = 0;
		var tindex = 0;
		for(var i=0;i < v_sub_taxinvoice.subject_markteting.length;i++)
		{
				tindex = i+1;
				th = 0;
				if ($("#addovst_id #dm"+tindex+" #th").val() != '') th = $("#addovst_id #dm"+tindex+" #th").val();						
				total_with_gst_markteting += parseFloat(th);
		}
		v_sub_taxinvoice.total_with_gst_markteting = Math.round(total_with_gst_markteting*100)/100;
		v_sub_taxinvoice.gsttotal_markteting = Math.round((v_sub_taxinvoice.total_with_gst_markteting/11)*100)/100;
		$("#addovst_id #b6c").html(v_sub_taxinvoice.gsttotal_markteting);
		$("#addovst_id #b6d").html(v_sub_taxinvoice.total_with_gst_markteting);
}

function invoice_edit(invoiceNo,invoiceIds)
{		
		//详细页
		$.ajax({
      url: url+'invoice/selectInvoiecByNo?invoiceNo='+invoiceNo+'&invoiceIds='+invoiceIds,
      type: 'GET',
      dataType: 'json'
    }).done(function(response) {		        	
    	response = response.data;
    	console.log(response);    	
    	v_sub_taxinvoice.invoices = [];
    	v_sub_taxinvoice.invoices = response;
    	v_sub_taxinvoice.invoiceNo = invoiceNo;
    	v_sub_taxinvoice.invoiceIds = invoiceIds;    	
    	if (invoiceIds.indexOf("SF") == '0')
			{
					v_sub_taxinvoice.addservicefee_id = 1;
					$('#addservicefee_id #addservicefee_id_title').html('Edit Service Fee Tax Invoice');							
		    	$('#addservicefee_id #b0').html(invoiceIds);
		    	$('#addservicefee_id #b1').val(response.branch);
		    	$('#addservicefee_id #b1').attr("disabled","disabled");
		    	$('#addservicefee_id #b2').val(response.companyId);
		    	$('#addservicefee_id #b2').attr("disabled","disabled");   	
		    	$('#addservicefee_id #b2a').html(response.abn);
		    	$('#addservicefee_id #b3').html(response.address);
		    	$('#addservicefee_id #b3a').html(response.tel);
		    	$('#addservicefee_id #b3b').html(response.email);
		    	$('#addservicefee_id #b4a').html(invoiceNo);
		    	$('#addservicefee_id #b4b').val(formatDate(response.invoiceDate));
		    	$('#addservicefee_id #b4c').val(response.billTo);
		    	$('#addservicefee_id #b6a').html(response.subtotal);
		    	$('#addservicefee_id #b6b').html(response.gst);
		    	$('#addservicefee_id #b6c').html(response.totalGST);
		    	$('#addservicefee_id #b5a').html(response.accountname);
		    	$('#addservicefee_id #b5b').html(response.bsb);
		    	$('#addservicefee_id #b5c').html(response.accountno);
		    	$('#addservicefee_id #b7').html(response.note);		    		
		    	$('#addservicefee_id #ids').val(response.order_id);
		    	v_sub_taxinvoice.subject = [];
		    	for(var i=0;i < response.invoiceServiceFeeDescriptionDOList.length;i++)
		    	{
		    			var index = 0;				
							if (v_sub_taxinvoice.subject.length) index = v_sub_taxinvoice.subject.length;
							var tindex = index+1;
							v_sub_taxinvoice.subject.splice(index,0, {
								id: tindex,								
								description: '<input type="text" class="form-control small" style="" id="ta" value="'+response.invoiceServiceFeeDescriptionDOList[i].description+'">',
								unitprice: '<input type="text" class="form-control small" style="width:80px;" id="tb" onkeyup="total_amount(\'price\',this.value,$(this).parent().parent().attr(\'id\'));" value="'+response.invoiceServiceFeeDescriptionDOList[i].unitPrice+'">',
								quantity: '<select class="form-control small" style="width:80px;" id="tc" onchange="total_amount(\'quantity\',this.value,$(this).parent().parent().attr(\'id\'))"><option value=\'1\'>1</option><option value=\'2\'>2</option><option value=\'3\'>3</option><option value=\'4\'>4</option><option value=\'5\'>5</option></select>',
								amount: '<input type="text" autocomplete="off" class="form-control small" style="width:80px;" id="td" readonly="readonly" value="'+response.invoiceServiceFeeDescriptionDOList[i].amount+'">',
							});
							//选中quantity
							$("#addservicefee_id #d"+tindex+" #tc").val(response.invoiceServiceFeeDescriptionDOList[i].quantity);
							v_sub_taxinvoice.row_nums++;				
		    	}
		    	v_sub_taxinvoice.bind_total = 1;
		    	$('#addservicefee_id').modal('show');	
    	}else if (invoiceIds.indexOf("SC") == '0')
    	{
    			v_sub_taxinvoice.addovst_id = 1;
    			$('#addovst_id #addovst_id_title').html('Edit 留学 Tax Invoice');
    			$("#addovst_id #label_b8d").hide();
    			$('#addovst_id #b0').html(invoiceIds);
		    	$('#addovst_id #b1').val(response.branch);
		    	$('#addovst_id #b1').attr("disabled","disabled");
		    	$('#addovst_id #b2').val(response.company);
		    	$('#addovst_id #b2').attr("disabled","disabled");
		    	$('#addovst_id #b2a').html(response.abn);
		    	$('#addovst_id #b3').html(response.address);
		    	$('#addovst_id #b3a').html(response.tel);
		    	$('#addovst_id #b3b').html(response.email);
		    	$('#addovst_id #b4a').html(invoiceNo);
		    	$('#addovst_id #b4b').val(formatDate(response.invoiceDate));
		    	$('#addovst_id #b6a').html(response.gst);
		    	$('#addovst_id #b6b').html(response.totalGST);
		    	$('#addovst_id #b5a').html(response.accountname);
		    	$('#addovst_id #b5b').html(response.bsb);
		    	$('#addovst_id #b5c').html(response.accountno);
		    	$('#addovst_id #b7').html(response.note);		    			    	
		    	if (response.invoiceBillToDO != null)
		    	{
		    			$('#addovst_id #b8a').val(response.invoiceBillToDO.company);
		    			$('#addovst_id #b8b').val(response.invoiceBillToDO.abn);
		    			$('#addovst_id #b8c').val(response.invoiceBillToDO.address);
		    	}		    	
		    	v_sub_taxinvoice.subject_normal = [];
		    	v_sub_taxinvoice.subject_markteting = [];
		    	if (response.flag == 'N')
		    	{
		    			$('#addovst_id #ids_normal').val(response.order_id);
		    			$('#addovst_id #li_normal').show();
		    			$("#addovst_id #li_normal").addClass("active");
		    			$("#addovst_id #normal").addClass("active");
		    			$('#addovst_id #li_markteting').hide();
		    			$("#addovst_id #li_markteting").removeClass("active");
		    			$("#addovst_id #markteting").removeClass("active");
				    	for(var i=0;i < response.invoiceSchoolDescriptionDOS.length;i++)
				    	{
				    			var index = 0;
									if (v_sub_taxinvoice.subject_normal.length) index = v_sub_taxinvoice.subject_normal.length;
									var tindex = index+1;
									v_sub_taxinvoice.subject_normal.splice(index,0, {
										id: tindex,
										studentname: '<input type="text" class="form-control small" style="" id="ta" value="'+response.invoiceSchoolDescriptionDOS[i].studentname+'">',
										dob: '<input type="text" class="form-control small default-date-picker" style="width:110px;" id="tb" value="'+v.getTime(response.invoiceSchoolDescriptionDOS[i].dob)+'">',
										studentId: '<input type="text" class="form-control small" style="width:80px;" id="tc" value="'+response.invoiceSchoolDescriptionDOS[i].studentId+'">',
										course: '<textarea class="form-control" style="width:150px;" id="td">'+response.invoiceSchoolDescriptionDOS[i].course+'</textarea>',
										startDate: '<input type="text" class="form-control small default-date-picker" style="width:110px;" id="te" value="'+v.getTime(response.invoiceSchoolDescriptionDOS[i].startDate)+'">',
										instalMent: '<select class="form-control small" style="width:80px;" id="tf"><option value=\'1\'>1</option><option value=\'2\'>2</option><option value=\'3\'>3</option><option value=\'4\'>4</option><option value=\'5\'>5</option><option value=\'6\'>6</option><option value=\'7\'>7</option><option value=\'8\'>8</option><option value=\'9\'>9</option><option value=\'10\'>10</option><option value=\'11\'>11</option><option value=\'12\'>12</option></select>',
										tuitionFee: '<input type="text" autocomplete="off" class="form-control small" style="width:100px;" id="tg" value="'+response.invoiceSchoolDescriptionDOS[i].tuitionFee+'">',
										commissionrate: '<input type="text" autocomplete="off" class="form-control small" style="width:100px;" id="th" value="'+response.invoiceSchoolDescriptionDOS[i].commissionrate+'">',
										commission: '<input type="text" autocomplete="off" class="form-control small" style="width:100px;" id="ti" onkeyup="total_withgst_normal();" value="'+response.invoiceSchoolDescriptionDOS[i].commission+'">',
										bonus: '<input type="text" autocomplete="off" class="form-control small" style="width:100px;" id="tj" onkeyup="total_withgst_normal();" value="'+response.invoiceSchoolDescriptionDOS[i].bonus+'">',										
									});
									//选中quantity
									$("#addovst_id #d"+tindex+" #tf").val(response.invoiceSchoolDescriptionDOS[i].instalMent);
									v_sub_taxinvoice.row_nums_normal++;													
				    	}
				    	v_sub_taxinvoice.bind_total_normal = 1;
		    	}else
		    	{
		    			$('#addovst_id #ids_markteting').val(response.order_id);
		    			$('#addovst_id #li_normal').hide();
		    			$("#addovst_id #li_normal").removeClass("active");
		    			$("#addovst_id #normal").removeClass("active");
		    			$("#addovst_id #markteting").addClass("active");
		    			$("#addovst_id #li_markteting").addClass("active");
		    			$('#addovst_id #li_markteting').show();		    					    	
				    	for(var i=0;i < response.invoiceSchoolDescriptionDOS.length;i++)
				    	{
				    			var index = 0;
									if (v_sub_taxinvoice.subject_markteting.length) index = v_sub_taxinvoice.subject_markteting.length;
									var tindex = index+1;
									v_sub_taxinvoice.subject_markteting.splice(index,0, {
										id: tindex,
										studentname: '<input type="text" class="form-control small" style="" id="ta" value="'+response.invoiceSchoolDescriptionDOS[i].studentname+'">',
										dob: '<input type="text" class="form-control small default-date-picker" style="width:110px;" id="tb" value="'+v.getTime(response.invoiceSchoolDescriptionDOS[i].dob)+'">',
										studentId: '<input type="text" class="form-control small" style="width:80px;" id="tc" value="'+response.invoiceSchoolDescriptionDOS[i].studentId+'">',
										course: '<textarea class="form-control" style="width:150px;" id="td">'+response.invoiceSchoolDescriptionDOS[i].course+'</textarea>',
										startDate: '<input type="text" class="form-control small default-date-picker" style="width:110px;" id="te" value="'+v.getTime(response.invoiceSchoolDescriptionDOS[i].startDate)+'">',
										instalMent: '<select class="form-control small" style="width:80px;" id="tf"><option value=\'1\'>1</option><option value=\'2\'>2</option><option value=\'3\'>3</option><option value=\'4\'>4</option><option value=\'5\'>5</option><option value=\'6\'>6</option><option value=\'7\'>7</option><option value=\'8\'>8</option><option value=\'9\'>9</option><option value=\'10\'>10</option><option value=\'11\'>11</option><option value=\'12\'>12</option></select>',
										tuitionFee: '<input type="text" autocomplete="off" class="form-control small" style="width:100px;" id="tg" value="'+response.invoiceSchoolDescriptionDOS[i].tuitionFee+'">',						
										marketing: '<input type="text" autocomplete="off" class="form-control small" style="width:100px;" id="th" onkeyup="total_withgst_markteting()" value="'+response.invoiceSchoolDescriptionDOS[i].marketing+'">',								
									});
									//选中quantity
									$("#addovst_id #d"+tindex+" #tf").val(response.invoiceSchoolDescriptionDOS[i].instalMent);
									v_sub_taxinvoice.row_nums_markteting++;
				    	}
				    	v_sub_taxinvoice.bind_total_markteting = 1;
		    	}
    			$('#addovst_id').modal('show');
    	}
    });		
}

v_sub_taxinvoice.$watch('addservicefee_id', function(obj) {
		$('.default-date-picker').datepicker({   				
	        format: 'dd/mm/yyyy'
	  });
	  $('.default-date-picker1').datepicker({   				
	        format: 'dd/mm/yyyy'			        
	  });
	  //绑定地区
    var obj_b1 = $("#addservicefee_id #b1");
    $("#addservicefee_id #b1").empty();
    obj_b1.append("<option value=''>请选择</option>");
    $.ajax({
      url: url+'invoice/selectAddress',
      type: 'GET',
      dataType: 'json'
    }).done(function(response) {
    	var result_data = response.data;    	
    	for (var item in result_data)
    	{
    			obj_b1.append("<option value='"+result_data[item]+"'>"+result_data[item]+"</option>");	        			
    	}
    	if (v_sub_taxinvoice.invoices.branch) obj_b1.val(v_sub_taxinvoice.invoices.branch);
    });
    //绑定公司
    var obj_b2 = $("#addservicefee_id #b2");
    $("#addservicefee_id #b2").empty();
    obj_b2.append("<option value=''>请选择</option>");
    $.ajax({
      url: url+'invoice/selectCompanySF',
      type: 'GET',
      dataType: 'json'
    }).done(function(response) {
    	var result_data = response.data;    	
    	for (var item in result_data)
    	{
    			obj_b2.append("<option value='"+result_data[item]+"'>"+result_data[item]+"</option>");	        			
    	}
    	if (v_sub_taxinvoice.invoices.company) obj_b2.val(v_sub_taxinvoice.invoices.company);
    });       
});

v_sub_taxinvoice.$watch('addovst_id', function(obj) {		
	  //绑定地区
    var obj_b1 = $("#addovst_id #b1");
    $("#addovst_id #b1").empty();
    obj_b1.append("<option value=''>请选择</option>");
    $.ajax({
      url: url+'invoice/selectAddress',
      type: 'GET',
      dataType: 'json'
    }).done(function(response) {
    	var result_data = response.data;    	
    	for (var item in result_data)
    	{
    			obj_b1.append("<option value='"+result_data[item]+"'>"+result_data[item]+"</option>");	        			
    	}
    	if (v_sub_taxinvoice.invoices.branch) obj_b1.val(v_sub_taxinvoice.invoices.branch);
    });
    //绑定公司
    var obj_b2 = $("#addovst_id #b2");
    $("#addovst_id #b2").empty();
    obj_b2.append("<option value=''>请选择</option>");
    $.ajax({
      url: url+'invoice/selectCompanySC',
      type: 'GET',
      dataType: 'json'
    }).done(function(response) {
    	var result_data = response.data;    	
    	for (var item in result_data)
    	{
    			obj_b2.append("<option value='"+result_data[item].name+"'>"+result_data[item].name+"</option>");	        			
    	}
    	if (v_sub_taxinvoice.invoices.company) obj_b2.val(v_sub_taxinvoice.invoices.company);
    });
    //绑定bill
    var obj_b8a = $("#addovst_id #b8a");
    $("#addovst_id #b8a").empty();
    obj_b8a.append("<option value=''>请选择</option>");
    $.ajax({
      url: url+'invoice/selectBillTo',
      type: 'GET',
      dataType: 'json'
    }).done(function(response) {
    	var result_data = response.data;    	
    	for (var item in result_data)
    	{
    			v_sub_taxinvoice.bill_company[result_data[item].id] = result_data[item];
    			obj_b8a.append("<option value='"+result_data[item].id+"'>"+result_data[item].company+"</option>");	        			
    	}
    	if (v_sub_taxinvoice.invoices.invoiceBillToDO != null) obj_b8a.val(v_sub_taxinvoice.invoices.invoiceBillToDO.id);
    	obj_b8a.append("<option value='0'>新添加</option>");
    });
});

v_sub_taxinvoice.$watch('subject_normal', function(obj) {
		$('.default-date-picker').datepicker({   				
	        format: 'dd/mm/yyyy'
	  });
	  $('.default-date-picker1').datepicker({   				
	        format: 'dd/mm/yyyy'			        
	  });
});

v_sub_taxinvoice.$watch('subject_markteting', function(obj) {
		$('.default-date-picker').datepicker({   				
	        format: 'dd/mm/yyyy'
	  });
	  $('.default-date-picker1').datepicker({   				
	        format: 'dd/mm/yyyy'			        
	  });
});

v_sub_taxinvoice.$watch('bind_total', function(obj) {
		total_withgst();
		v_sub_taxinvoice.bind_total = 0;
});

v_sub_taxinvoice.$watch('bind_total_normal', function(obj) {
		total_withgst_normal();
		v_sub_taxinvoice.bind_total_normal = 0;
});

v_sub_taxinvoice.$watch('bind_total_markteting', function(obj) {
		total_withgst_markteting();
		v_sub_taxinvoice.bind_total_markteting = 0;
});

function addservicefeeSave()
{
		var f = '#addservicefee_id ';
		var check_result = 0;
		var e_info = '';
		
		if (!v_sub_taxinvoice.row_nums)
		{
				e_info = '提示：Description行不能为空！';
		}else
		{
				//校验第一行是否为空
				var description = $(f+'#d1 #ta').val();
				var unitprice = $(f+'#d1 #tb').val();
				if (description == '' || unitprice == '')
				{
						e_info = '提示：Description行内容有空的字段！';
				}else
				{
						check_result = 1;
				}				
		}		
		
		if (!check_result) 		
    {
    		$(f+'#alert_error').css('marginLeft','30%');
    		$(f+'#alert_error').css('marginTop','20%');
    		$(f+'#alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
        $(f+'#error_info').html(e_info);
    		return false;
    }else
    {
    		var str_url = url+"invoice/saveServiceFeeInvoice";    		  		
       	var json = {};        	
       	
				var invoiceDate = formatDate2($(f+'#b4b').val());				
       	json['invoiceDate'] = invoiceDate;
       	json['billTo'] = $(f+'#b4c').val();       	
       	json['email'] = v_sub_taxinvoice.invoices.email;
       	json['company'] = v_sub_taxinvoice.invoices.name;
       	json['abn'] = v_sub_taxinvoice.invoices.abn;
       	json['address'] = v_sub_taxinvoice.invoices.address;
       	json['tel'] = v_sub_taxinvoice.invoices.tel;
       	json['invoiceNo'] = v_sub_taxinvoice.invoices.invoiceNo;
       	json['note'] = $(f+'#b7').val();
       	json['accountname'] = v_sub_taxinvoice.invoices.name;
       	json['bsb'] = v_sub_taxinvoice.invoices.bsb;
       	json['accountno'] = v_sub_taxinvoice.invoices.account;
       	json['state'] = 'NORMAL';
       	json['branch'] = $(f+'#b1').val();
       	json['idList'] = $(f+'#ids').val();       	
       	json['descriptionList'] = [];
       	var tindex = 0;       	
       	for(var i=0;i< v_sub_taxinvoice.row_nums;i++)
       	{
       			var tindex = i+1;
       			json['descriptionList'][i] = {};
       			json['descriptionList'][i]['id'] = tindex;
       			json['descriptionList'][i]['description'] = $("#addservicefee_id #d"+tindex+" #ta").val();
       			json['descriptionList'][i]['unitPrice'] = $("#addservicefee_id #d"+tindex+" #tb").val();
       			json['descriptionList'][i]['quantity'] = $("#addservicefee_id #d"+tindex+" #tc").val();
       			json['descriptionList'][i]['amount'] = $("#addservicefee_id #d"+tindex+" #td").val();
       	}        	   	
       	console.log(json);
       	//return false;
       	show_loading();
       	$.ajax({
		      url: str_url,
		      type: 'POST',
		      async: false,
		      contentType:"application/json",
		      dataType: 'json',
		      data: JSON.stringify(json),
		    }).done(function(data) {		    		
		    		if (data.code == 0)
		   			{
		   					//调用生成pdf接口
		   					$.ajax({
						      url: url+'invoice/pdfPrint?invoiceNo='+json['invoiceNo']+'&invoiceIds=SF',
						      type: 'GET',
						    }).done(function(response){
						    			$('#loading_id').modal('hide');
						    			if (response.code == 0)
						    			{
						    					//触发下载pdf
						    					var pdf_url = response.message;
						    					var a = document.createElement('a');
													a.href = pdf_url;
													a.target = '_blank';
													$("body").append(a);
													a.click();
													$(a).remove();
						    					localStorage.setItem("is_select", "no");
							   					$(f+'#alert_success').css('marginTop','30%');
							   					$(f+'#alert_success').css('marginLeft','30%');
							   					$(f+'#alert_success').addClass('alert-success').show().delay(1500).fadeOut();
							   					$('#addservicefee_id').modal('hide');
							   					v.getDatalist();
							   					$('.modal-backdrop').remove();
						    			}else
						    			{
						    					$('#loading_id').modal('hide');
							   					$(f+'#alert_error').css('marginTop','30%');
							   					$(f+'#alert_error').css('marginLeft','30%');
							   					$(f+'#alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
					          			$(f+"#error_info").html(data.message);
						        			return false;
						    			}
						    });		   					
		   			}else
		   			{
		   					$('#loading_id').modal('hide');
		   					$(f+'#alert_error').css('marginTop','30%');
		   					$(f+'#alert_error').css('marginLeft','30%');
		   					$(f+'#alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
          			$(f+"#error_info").html(data.message);
	        			return false;
		   			}
		    });
    }
}

function addovstSave()
{
		var f = '#addovst_id ';
		var check_result = 0;
		var e_info = '';
		
		if (!v_sub_taxinvoice.row_nums_normal && !v_sub_taxinvoice.row_nums_markteting)
		{
				e_info = '提示：Description行不能为空！';
		}else
		{
				//校验normal行是否有空				
				for(var i=1;i<= v_sub_taxinvoice.row_nums_normal;i++)
       	{
       			if ($(f+'#d'+i+' #ta').val() == '' || $(f+'#d'+i+' #tb').val() == '' || $(f+'#d'+i+' #tc').val() == '' || $(f+'#d'+i+' #td').val() == '' || $(f+'#d'+i+' #te').val() == '' || $(f+'#d'+i+' #tg').val() == '' || $(f+'#d'+i+' #th').val() == '' || $(f+'#d'+i+' #ti').val() == '' || $(f+'#d'+i+' #tj').val() == '') e_info += 'Normal 第'+i+'行有空字段！<br/>';       			
       	}
       	//校验markteting行是否有空
				for(var i=1;i<= v_sub_taxinvoice.row_nums_markteting;i++)
       	{
       			if ($(f+'#dm'+i+' #ta').val() == '' || $(f+'#dm'+i+' #tb').val() == '' || $(f+'#dm'+i+' #tc').val() == '' || $(f+'#dm'+i+' #td').val() == '' || $(f+'#dm'+i+' #te').val() == '' || $(f+'#dm'+i+' #tg').val() == '' || $(f+'#dm'+i+' #th').val() == '') e_info += 'Markteting Fee 第'+i+'行有空字段！<br/>';       			
       	}
       	if (e_info == '') check_result = 1;       	
		}
		
		if (!check_result) 		
    {
    		$(f+'#alert_error').css('marginLeft','30%');
    		$(f+'#alert_error').css('marginTop','30%');
    		$(f+'#alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
        $(f+'#error_info').html(e_info);
    		return false;
    }else
    {
    		var str_url = url+"invoice/saveSchoolInvoice";
    		var str_url1 = url+"invoice/addBillTo";
       	var json = {};
       	var billCpId = 0;
       	
       	//如果是添加bill公司,写库获取billto_id
       	if (!parseInt(v_sub_taxinvoice.billCpId))
       	{
		       	$.ajaxSettings.async = false; 
		       	var b8a = $(f+"#b8a").val();		
						if (!parseInt(b8a))
						{
								var billto_json = {};
								billto_json['company'] = $(f+"#b8d").val();
								billto_json['abn'] = $(f+"#b8b").val();
								billto_json['address'] = $(f+"#b8c").val();
								$.post(str_url1, billto_json,
				   			function(data){
				   					if (data.code == 0)
				   					{
				   							billCpId = data.data;
				   							v_sub_taxinvoice.billCpId = billCpId;
				   					}else
				   					{
				   							$(f+"#b8d")[0].focus();
				   							$(f+'#alert_error').css('marginLeft','30%');
								    		$(f+'#alert_error').css('marginTop','30%');
								    		$(f+'#alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
								        $(f+'#error_info').html(data.message);						    		
				   					}
				   			});
						}else
						{
								billCpId = b8a;
						}
				}else
				{
						billCpId = v_sub_taxinvoice.billCpId;
				}
				if (!billCpId) return false;				
				
       	var invoiceDate = formatDate2($(f+'#b4b').val());
       	json['invoiceDate'] = invoiceDate;
       	json['email'] = v_sub_taxinvoice.invoices.email;
       	json['company'] = v_sub_taxinvoice.invoices.name;
       	json['companyId'] = v_sub_taxinvoice.invoices.id;       	
       	json['abn'] = v_sub_taxinvoice.invoices.abn;
       	json['address'] = v_sub_taxinvoice.invoices.address;
       	json['tel'] = v_sub_taxinvoice.invoices.tel;
       	json['invoiceNo'] = v_sub_taxinvoice.invoices.invoiceNo;
       	json['note'] = $(f+'#b7').val();
       	json['accountname'] = v_sub_taxinvoice.invoices.name;
       	json['bsb'] = v_sub_taxinvoice.invoices.bsb;
       	json['accountno'] = v_sub_taxinvoice.invoices.account;
       	json['billto_id'] = billCpId;       	
       	json['state'] = 'NORMAL';
       	json['branch'] = $(f+'#b1').val();
       	json['idList'] = $(f+'#ids_normal').val()+'#'+$(f+'#ids_markteting').val();
       	//json['idList'] = $(f+'#ids_normal').val();
       	json['normal'] = [];
       	var tindex = 0;       	
       	for(var i=0;i< v_sub_taxinvoice.row_nums_normal;i++)
       	{
       			var tindex = i+1;
       			json['normal'][i] = {};
       			json['normal'][i]['id'] = tindex;
       			json['normal'][i]['studentname'] = $(f+"#d"+tindex+" #ta").val();
       			//日期格式转化：Y-m-d
       			json['normal'][i]['dob'] = formatDate2($(f+"#d"+tindex+" #tb").val());
       			json['normal'][i]['studentId'] = $(f+"#d"+tindex+" #tc").val();
       			json['normal'][i]['course'] = $(f+"#d"+tindex+" #td").val();
       			json['normal'][i]['startDate'] = formatDate2($(f+"#d"+tindex+" #te").val());
       			json['normal'][i]['instalMent'] = $(f+"#d"+tindex+" #tf").val();
       			json['normal'][i]['tuitionFee'] = $(f+"#d"+tindex+" #tg").val();
       			json['normal'][i]['commissionrate'] = $(f+"#d"+tindex+" #th").val();
       			json['normal'][i]['commission'] = $(f+"#d"+tindex+" #ti").val();
       			json['normal'][i]['bonus'] = $(f+"#d"+tindex+" #tj").val();
       	}
       	json['marketing'] = [];
       	for(var i=0;i< v_sub_taxinvoice.row_nums_markteting;i++)
       	{
       			var tindex = i+1;
       			json['marketing'][i] = {};
       			json['marketing'][i]['id'] = tindex;
       			json['marketing'][i]['studentname'] = $(f+"#dm"+tindex+" #ta").val();
       			json['marketing'][i]['dob'] = formatDate2($(f+"#dm"+tindex+" #tb").val());
       			json['marketing'][i]['studentId'] = $(f+"#dm"+tindex+" #tc").val();
       			json['marketing'][i]['course'] = $(f+"#dm"+tindex+" #td").val();
       			json['marketing'][i]['startDate'] = formatDate2($(f+"#dm"+tindex+" #te").val());
       			json['marketing'][i]['instalMent'] = $(f+"#dm"+tindex+" #tf").val();
       			json['marketing'][i]['tuitionFee'] = $(f+"#dm"+tindex+" #tg").val();
       			json['marketing'][i]['marketing'] = $(f+"#dm"+tindex+" #th").val();       			
       	}
       	console.log(json);
       	//return false;
       	show_loading();
       	$.ajax({
		      url: str_url,
		      type: 'POST',
		      async: false,
		      contentType:"application/json",
		      dataType: 'json',
		      data: JSON.stringify(json),
		    }).done(function(data) {    		
		    		if (data.code == 0)
		   			{
		   					//生成normal的pdf  					
						    if (v_sub_taxinvoice.row_nums_normal) make_pdf(f,json['invoiceNo'],'SC');
						    //生成markteting的pdf
						    if (v_sub_taxinvoice.row_nums_markteting)
						    {
						    		if (v_sub_taxinvoice.row_nums_normal)
						    		{
						    				make_pdf(f,data.data,'SC');
						    		}else
						    		{
						    				make_pdf(f,json['invoiceNo'],'SC');
						    		}
						    }
						    localStorage.setItem("is_select", "no");
		   					$(f+'#alert_success').css('marginTop','30%');
		   					$(f+'#alert_success').css('marginLeft','30%');
		   					$(f+'#alert_success').addClass('alert-success').show().delay(1500).fadeOut();
		   					$('#addovst_id').modal('hide');
		   					//v.kind = 'SC';
		   					//v.getDatalist();
		   					//$('.modal-backdrop').remove();
		   					var go_url = 'taxinvoice-list.html?state=&type=SC';
		   					setTimeout(function(){window.location.href = go_url;}, 1500);
		   									    
		   			}else
		   			{
		   					$('#loading_id').modal('hide');
		   					$(f+'#alert_error').css('marginTop','30%');
		   					$(f+'#alert_error').css('marginLeft','30%');
		   					$(f+'#alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
          			$(f+"#error_info").html(data.message);
	        			return false;
		   			}
		    });
    }
}

function editservicefeeSave()
{
		var f = '#addservicefee_id ';
		var check_result = 0;
		var e_info = '';
		
		if (!v_sub_taxinvoice.row_nums)
		{
				e_info = '提示：Description行不能为空！';
		}else
		{
				//校验第一行是否为空
				var description = $(f+'#d1 #ta').val();
				var unitprice = $(f+'#d1 #tb').val();
				if (description == '' || unitprice == '')
				{
						e_info = '提示：Description行内容有空的字段！';
				}else
				{
						check_result = 1;
				}				
		}
		
		if (!check_result) 		
    {
    		$(f+'#alert_error').css('marginLeft','30%');
    		$(f+'#alert_error').css('marginTop','20%');
    		$(f+'#alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
        $(f+'#error_info').html(e_info);
    		return false;
    }else
    {
    		var str_url = url+"invoice/update";    		  		
       	var json = {};
       	
       	var invoiceDate = formatDate2($(f+'#b4b').val());
       	json['invoiceDate'] = invoiceDate;
       	json['billTo'] = $(f+'#b4c').val();          	       	
       	json['invoiceNo'] = v_sub_taxinvoice.invoiceNo;
       	json['note'] = $(f+'#b7').val();       	
       	json['idList'] = $(f+'#ids').val();
       	json['description'] = [];
       	var tindex = 0;       	
       	for(var i=0;i< v_sub_taxinvoice.row_nums;i++)
       	{
       			var tindex = i+1;
       			json['description'][i] = {};
       			json['description'][i]['id'] = tindex;
       			json['description'][i]['description'] = $("#addservicefee_id #d"+tindex+" #ta").val();
       			json['description'][i]['unitPrice'] = $("#addservicefee_id #d"+tindex+" #tb").val();
       			json['description'][i]['quantity'] = $("#addservicefee_id #d"+tindex+" #tc").val();
       			json['description'][i]['amount'] = $("#addservicefee_id #d"+tindex+" #td").val();
       	}        	   	
       	//console.log(json);
       	show_loading();
       	$.ajax({
		      url: str_url,
		      type: 'POST',
		      async: false,
		      contentType:"application/json",
		      dataType: 'json',
		      data: JSON.stringify(json),
		    }).done(function(data) {		    		
		    		if (data.code == 0)
		   			{
		   					//调用生成pdf接口
		   					$.ajax({
						      url: url+'invoice/pdfPrint?invoiceNo='+json['invoiceNo']+'&invoiceIds=SF',
						      type: 'GET',
						    }).done(function(response){
						    			$('#loading_id').modal('hide');
						    			if (response.code == 0)
						    			{
						    					//触发下载pdf
						    					var pdf_url = response.message;
						    					var a = document.createElement('a');
													a.href = url+pdf_url;
													a.target = '_blank';
													$("body").append(a);
													a.click();
													$(a).remove();
													v_sub_taxinvoice.addservicefee_id = 0;
													v_sub_taxinvoice.row_nums = 0;
													v_sub_taxinvoice.bind_total = 0;
						    					localStorage.setItem("is_select", "no");
							   					$(f+'#alert_success').css('marginTop','30%');
							   					$(f+'#alert_success').css('marginLeft','30%');
							   					$(f+'#alert_success').addClass('alert-success').show().delay(1500).fadeOut();
							   					$('#addservicefee_id').modal('hide');
							   					v.getDatalist();
							   					$('.modal-backdrop').remove();
						    			}else
						    			{
						    					$('#loading_id').modal('hide');
							   					$(f+'#alert_error').css('marginTop','30%');
							   					$(f+'#alert_error').css('marginLeft','30%');
							   					$(f+'#alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
					          			$(f+"#error_info").html(data.message);
						        			return false;
						    			}
						    });		   					
		   			}else
		   			{
		   					$('#loading_id').modal('hide');
		   					$(f+'#alert_error').css('marginTop','30%');
		   					$(f+'#alert_error').css('marginLeft','30%');
		   					$(f+'#alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
          			$(f+"#error_info").html(data.message);
	        			return false;
		   			}
		    });
    }
}

function editovstSave()
{
		var f = '#addovst_id ';
		var check_result = 0;
		var e_info = '';
		
		if (!v_sub_taxinvoice.row_nums_normal && !v_sub_taxinvoice.row_nums_markteting)
		{
				e_info = '提示：Description行不能为空！';
		}else
		{
				//校验normal行是否有空				
				for(var i=1;i<= v_sub_taxinvoice.row_nums_normal;i++)
       	{
       			if ($(f+'#d'+i+' #ta').val() == '' || $(f+'#d'+i+' #tb').val() == '' || $(f+'#d'+i+' #tc').val() == '' || $(f+'#d'+i+' #td').val() == '' || $(f+'#d'+i+' #te').val() == '' || $(f+'#d'+i+' #tg').val() == '' || $(f+'#d'+i+' #th').val() == '' || $(f+'#d'+i+' #ti').val() == '' || $(f+'#d'+i+' #tj').val() == '') e_info += 'Normal 第'+i+'行有空字段！<br/>';       			
       	}
       	//校验markteting行是否有空
				for(var i=1;i<= v_sub_taxinvoice.row_nums_markteting;i++)
       	{
       			if ($(f+'#dm'+i+' #ta').val() == '' || $(f+'#dm'+i+' #tb').val() == '' || $(f+'#dm'+i+' #tc').val() == '' || $(f+'#dm'+i+' #td').val() == '' || $(f+'#dm'+i+' #te').val() == '' || $(f+'#dm'+i+' #tg').val() == '' || $(f+'#dm'+i+' #th').val() == '') e_info += 'Markteting Fee 第'+i+'行有空字段！<br/>';       			
       	}
       	if (e_info == '') check_result = 1;       	
		}
		
		if (!check_result) 		
    {
    		$(f+'#alert_error').css('marginLeft','30%');
    		$(f+'#alert_error').css('marginTop','30%');
    		$(f+'#alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
        $(f+'#error_info').html(e_info);
    		return false;
    }else
    {
    		var str_url = url+"invoice/update";
    		var str_url1 = url+"invoice/addBillTo";
       	var json = {};
       	var billCpId = 0;
       	
       	//如果是添加bill公司,写库获取billto_id
       	if (!parseInt(v_sub_taxinvoice.billCpId))
       	{
		       	$.ajaxSettings.async = false; 
		       	var b8a = $(f+"#b8a").val();		
						if (!parseInt(b8a))
						{
								var billto_json = {};
								billto_json['company'] = $(f+"#b8d").val();
								billto_json['abn'] = $(f+"#b8b").val();
								billto_json['address'] = $(f+"#b8c").val();
								$.post(str_url1, billto_json,
				   			function(data){
				   					if (data.code == 0)
				   					{
				   							billCpId = data.data;
				   							v_sub_taxinvoice.billCpId = billCpId;
				   					}else
				   					{
				   							$(f+"#b8d")[0].focus();
				   							$(f+'#alert_error').css('marginLeft','30%');
								    		$(f+'#alert_error').css('marginTop','30%');
								    		$(f+'#alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
								        $(f+'#error_info').html(data.message);						    		
				   					}
				   			});
						}else
						{
								billCpId = b8a;
						}
				}else
				{
						billCpId = v_sub_taxinvoice.billCpId;
				}
				if (!billCpId) return false;				
				
       	//json['invoiceDate'] = v.getTime2(v_sub_taxinvoice.invoices.invoiceDate);
       	var invoiceDate = formatDate2($(f+'#b4b').val());
       	json['invoiceDate'] = invoiceDate;
       	json['invoiceNo'] = v_sub_taxinvoice.invoices.invoiceNo;
       	json['note'] = $(f+'#b7').val();       	
       	json['billto_id'] = billCpId;
       	if (v_sub_taxinvoice.invoices.flag == 'N')
       	{
       			json['idList'] = $(f+'#ids_normal').val();
       			json['description'] = [];
		       	var tindex = 0;       	
		       	for(var i=0;i< v_sub_taxinvoice.row_nums_normal;i++)
		       	{
		       			var tindex = i+1;
		       			json['description'][i] = {};
		       			json['description'][i]['id'] = tindex;
		       			json['description'][i]['studentname'] = $(f+"#d"+tindex+" #ta").val();
		       			//日期格式转化：Y-m-d
		       			json['description'][i]['dob'] = formatDate2($(f+"#d"+tindex+" #tb").val());
		       			json['description'][i]['studentId'] = $(f+"#d"+tindex+" #tc").val();
		       			json['description'][i]['course'] = $(f+"#d"+tindex+" #td").val();
		       			json['description'][i]['startDate'] = formatDate2($(f+"#d"+tindex+" #te").val());
		       			json['description'][i]['instalMent'] = $(f+"#d"+tindex+" #tf").val();
		       			json['description'][i]['tuitionFee'] = $(f+"#d"+tindex+" #tg").val();
		       			json['description'][i]['commissionrate'] = $(f+"#d"+tindex+" #th").val();
		       			json['description'][i]['commission'] = $(f+"#d"+tindex+" #ti").val();
		       			json['description'][i]['bonus'] = $(f+"#d"+tindex+" #tj").val();
		       	}
      	}else
      	{
      			json['idList'] = $(f+'#ids_markteting').val()
      			json['description'] = [];
		       	for(var i=0;i< v_sub_taxinvoice.row_nums_markteting;i++)
		       	{
		       			var tindex = i+1;
		       			json['description'][i] = {};
		       			json['description'][i]['id'] = tindex;
		       			json['description'][i]['studentname'] = $(f+"#dm"+tindex+" #ta").val();
		       			json['description'][i]['dob'] = formatDate2($(f+"#dm"+tindex+" #tb").val());
		       			json['description'][i]['studentId'] = $(f+"#dm"+tindex+" #tc").val();
		       			json['description'][i]['course'] = $(f+"#dm"+tindex+" #td").val();
		       			json['description'][i]['startDate'] = formatDate2($(f+"#dm"+tindex+" #te").val());
		       			json['description'][i]['instalMent'] = $(f+"#dm"+tindex+" #tf").val();
		       			json['description'][i]['tuitionFee'] = $(f+"#dm"+tindex+" #tg").val();
		       			json['description'][i]['marketing'] = $(f+"#dm"+tindex+" #th").val();       			
		       	}
      	}       	
       	
       	console.log(json);
       	//return false;
       	show_loading();
       	$.ajax({
		      url: str_url,
		      type: 'POST',
		      async: false,
		      contentType:"application/json",
		      dataType: 'json',
		      data: JSON.stringify(json),
		    }).done(function(data) {    		
		    		if (data.code == 0)
		   			{
		   					//生成normal的pdf  					
						    if (v_sub_taxinvoice.row_nums_normal) make_pdf(f,json['invoiceNo'],'SC');
						    //生成markteting的pdf
						    if (v_sub_taxinvoice.row_nums_markteting)
						    {
						    		if (v_sub_taxinvoice.row_nums_normal)
						    		{
						    				make_pdf(f,data.data,'SC');
						    		}else
						    		{
						    				make_pdf(f,json['invoiceNo'],'SC');
						    		}
						    }
						    localStorage.setItem("is_select", "no");
		   					$(f+'#alert_success').css('marginTop','30%');
		   					$(f+'#alert_success').css('marginLeft','30%');
		   					$(f+'#alert_success').addClass('alert-success').show().delay(1500).fadeOut();
		   					$('#addovst_id').modal('hide');
		   					//v.kind = 'SC';
		   					//v.getDatalist();
		   					//$('.modal-backdrop').remove();
		   					var go_url = 'taxinvoice-list.html?state=&type=SC';
		   					setTimeout(function(){window.location.href = go_url;}, 1500);
		   									    
		   			}else
		   			{
		   					$('#loading_id').modal('hide');
		   					$(f+'#alert_error').css('marginTop','30%');
		   					$(f+'#alert_error').css('marginLeft','30%');
		   					$(f+'#alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
          			$(f+"#error_info").html(data.message);
	        			return false;
		   			}
		    });
    }
}

function make_pdf(f,invoiceNo,type)
{
		//调用生成pdf接口
		$.ajax({
      url: url+'invoice/pdfPrint?invoiceNo='+invoiceNo+'&invoiceIds='+type,
      type: 'GET',
    }).done(function(response){
    			$('#loading_id').modal('hide');
    			if (response.code == 0)
    			{
    					//触发下载pdf
    					var pdf_url = response.message;
    					var a = document.createElement('a');
							a.href = pdf_url;
							a.target = '_blank';
							$("body").append(a);
							a.click();
							$(a).remove();    					
    			}else
    			{
    					$('#loading_id').modal('hide');
	   					$(f+'#alert_error').css('marginTop','30%');
	   					$(f+'#alert_error').css('marginLeft','30%');
	   					$(f+'#alert_error').addClass('alert-danger').show().delay(3000).fadeOut();
        			$(f+"#error_info").html(data.message);
        			return false;
    			}
    });
}

function taxinvoice_download(invoiceNo,invoiceIds)
{
		//var down_url = url+'data/upload/pdf/'+invoiceNo.substring(0,6)+'/'+invoiceNo+'_'+invoiceIds+'.pdf';
		var down_url = '/statics/uploads/pdf/'+invoiceNo.substring(0,6)+'/'+invoiceNo+'_'+invoiceIds+'.pdf';
		var a = document.createElement('a');
		a.href = down_url;
		a.target = '_blank';
		$("body").append(a);
		a.click();
		$(a).remove();
}

$('#addservicefee_id').on('show.bs.modal', function () {
	$("#addservicefee_form").validate({
			submitHandler: function () {
						if(v_sub_taxinvoice.invoiceNo == '')
						{						
            		addservicefeeSave();
            }else
            {
            		editservicefeeSave();
            }
      },
      rules: {
          b1: "required",
          b2: "required",
          b4c: "required",       
      },
      messages: {
          b1: "必选",
          b2: "必选",         
          b4c: "必填",         
      }
  });
});

$('#addovst_id').on('show.bs.modal', function () {
	$("#addovst_form").validate({
			submitHandler: function () {
						if(v_sub_taxinvoice.invoiceNo == '')
						{						
            		addovstSave();
            }else
            {
            		editovstSave();
            }
      },
      rules: {
          b1: "required",
          b2: "required",          
          b8a: "required",
          //b8b: "required",
          b8c: "required",
      },
      messages: {
          b1: "必选",
          b2: "必选",         
          b8a: "必选",
          //b8b: "必填",
          b8c: "必填",
      }
  });
});

$('#addservicefee_id').on('hidden.bs.modal', function () {
	v_sub_taxinvoice.addservicefee_id = 0;
	v_sub_taxinvoice.row_nums = 0;
	v_sub_taxinvoice.bind_total = 0;
	localStorage.setItem("is_select", "no");
});
$('#addovst_id').on('hidden.bs.modal', function () {
	v_sub_taxinvoice.addovst_id = 0;
	localStorage.setItem("is_select", "no");
});
</script>